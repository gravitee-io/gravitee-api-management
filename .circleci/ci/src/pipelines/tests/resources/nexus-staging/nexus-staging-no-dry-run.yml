# This configuration has been automatically generated by the CircleCI Config SDK.
# For more information, see https://github.com/CircleCI-Public/circleci-config-sdk-ts
# SDK Version: 0.0.0-development

version: 2.1
setup: false
parameters:
  gio_action:
    type: string
    default: pull_requests
    description: ""
  dry_run:
    type: boolean
    default: true
    description: Run in dry run mode?
  docker_tag_as_latest:
    type: boolean
    default: false
    description: Is this version the latest version available?
  graviteeio_version:
    type: string
    default: ""
    description: Version of APIM to be used in docker images
  apim_version_path:
    type: string
    default: /home/circleci/project/pom.xml
    description: Path to pom.xml with APIM version
commands:
  cmd-restore-maven-job-cache:
    parameters:
      jobName:
        type: string
        default: ""
        description: The job name
    steps:
      - restore_cache:
          keys:
            - gravitee-api-management-v10-<< parameters.jobName >>-{{ .Branch }}-{{ checksum "pom.xml" }}
            - gravitee-api-management-v10-<< parameters.jobName >>-{{ .Branch }}
    description: Restore Maven cache for a dedicated job
  cmd-prepare-gpg:
    steps:
      - keeper/install
      - run:
          command: |-
            ksm secret notation keeper://riW92t8X4tk4ZmQc8-FZ4Q/custom_field/armor_format_pub_key > pub.key
            gpg --import pub.key

            ksm secret notation keeper://riW92t8X4tk4ZmQc8-FZ4Q/custom_field/armor_format_private_key > private.key
            # Need --batch to be able to import private key
            gpg --import --batch private.key
    description: Prepare GPG command
  cmd-save-maven-job-cache:
    parameters:
      jobName:
        type: string
        default: ""
        description: The job name
    steps:
      - run:
          name: Exclude all APIM artefacts from cache.
          command: rm -rf ~/.m2/repository/io/gravitee/apim
      - save_cache:
          key: gravitee-api-management-v10-<< parameters.jobName >>-{{ .Branch }}-{{ checksum "pom.xml" }}
          paths:
            - ~/.m2
          when: always
    description: Save Maven cache for a dedicated job
jobs:
  job-setup:
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - checkout
      - keeper/env-export:
          secret-url: keeper://7CgijuGiFDSLynRJt1Dm9w/custom_field/xml
          var-name: MAVEN_SETTINGS
      - run:
          command: "echo $MAVEN_SETTINGS > .gravitee.settings.xml "
      - persist_to_workspace:
          root: .
          paths:
            - .gravitee.settings.xml
  job-nexus-staging:
    docker:
      - image: cimg/openjdk:17.0.8
    resource_class: xlarge
    steps:
      - checkout
      - run:
          name: Checkout tag 1.2.3-alpha.1
          command: git checkout 1.2.3-alpha.1
      - cmd-restore-maven-job-cache:
          jobName: job-nexus-staging
      - attach_workspace:
          at: .
      - cmd-prepare-gpg
      - run:
          name: Release on Nexus
          command: mvn clean deploy --activate-profiles gravitee-release --batch-mode -Dmaven.test.skip=true -DskipTests -Dskip.validation=true --settings .gravitee.settings.xml --update-snapshots
      - cmd-save-maven-job-cache:
          jobName: job-nexus-staging
  job-slack-announcement:
    parameters:
      message:
        type: string
        default: ""
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - keeper/env-export:
          secret-url: keeper://ZOz4db245GNaETVwmPBk8w/field/password
          var-name: SLACK_ACCESS_TOKEN
      - slack/notify:
          channel: C02NGT20S4W
          event: always
          custom: |-
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<< parameters.message >>"
                  }
                }
              ]
            }
workflows:
  nexus_staging:
    jobs:
      - job-setup:
          context:
            - cicd-orchestrator
          name: Setup
      - job-nexus-staging:
          context:
            - cicd-orchestrator
          name: Nexus staging
          requires:
            - Setup
      - job-slack-announcement:
          context:
            - cicd-orchestrator
          name: Announce end of release
          requires:
            - Nexus staging
          message: ðŸŽ† APIM - 1.2.3-alpha.1 released!
orbs:
  keeper: gravitee-io/keeper@0.6.3
  slack: circleci/slack@4.12.5
