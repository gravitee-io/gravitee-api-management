# This configuration has been automatically generated by the CircleCI Config SDK.
# For more information, see https://github.com/CircleCI-Public/circleci-config-sdk-ts
# SDK Version: 0.0.0-development

version: 2.1
setup: false
parameters:
  gio_action:
    type: string
    default: pull_requests
    description: ""
  dry_run:
    type: boolean
    default: true
    description: Run in dry run mode?
  docker_tag_as_latest:
    type: boolean
    default: false
    description: Is this version the latest version available?
  graviteeio_version:
    type: string
    default: ""
    description: Version of APIM to be used in docker images
  apim_version_path:
    type: string
    default: /home/circleci/project/pom.xml
    description: Path to pom.xml with APIM version
commands:
  cmd-install-yarn:
    steps:
      - run:
          name: Enable Corepack and Set Yarn Version
          command: |-
            corepack enable || sudo corepack enable
                    yarn set version 4.1.1
  cmd-notify-on-failure:
    steps:
      - keeper/env-export:
          secret-url: keeper://ZOz4db245GNaETVwmPBk8w/field/password
          var-name: SLACK_ACCESS_TOKEN
      - slack/notify:
          channel: C02JENTV2AX
          branch_pattern: master,[0-9]+\.[0-9]+\.x,alpha-vertx5
          event: fail
          template: basic_fail_1
jobs:
  job-danger-js:
    docker:
      - image: cimg/node:22.12.0
    resource_class: small
    steps:
      - checkout
      - cmd-install-yarn
      - keeper/env-export:
          secret-url: keeper://TIlcGPFq4rN5GvgnZb9hng/field/password
          var-name: DANGER_GITHUB_API_TOKEN
      - run:
          name: Run Danger JS
          command: cd .circleci/danger && yarn install && yarn run danger
  job-test-apim-charts:
    parameters:
      helmClientVersion:
        type: string
        default: v3.12.3
        description: Version of helm to test
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - checkout
      - helm/install_helm_client:
          version: << parameters.helmClientVersion >>
      - run:
          name: Install helm-unittest plugin
          command: helm plugin install https://github.com/helm-unittest/helm-unittest.git --version 0.5.1
      - run:
          name: Lint the helm charts available in helm/
          command: helm lint helm/
      - run:
          name: Execute the units tests in helm/
          command: helm unittest -f 'tests/**/*.yaml' helm/ -t JUnit -o apim-result.xml
      - store_test_results:
          path: apim-result.xml
      - cmd-notify-on-failure
  job-validate-workflow-status:
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - run:
          name: Check workflow jobs
          command: echo "Congratulations! If you can read this, everything is OK"
workflows:
  pull_requests:
    jobs:
      - aquasec/fs_scan:
          context:
            - cicd-orchestrator
          pre-steps:
            - keeper/env-export:
                secret-url: keeper://QeHHkvALPob4pgs1hMd9Gw/custom_field/API Key
                var-name: AQUA_KEY
            - keeper/env-export:
                secret-url: keeper://QeHHkvALPob4pgs1hMd9Gw/custom_field/Secret
                var-name: AQUA_SECRET
            - keeper/env-export:
                secret-url: keeper://TIlcGPFq4rN5GvgnZb9hng/field/password
                var-name: GITHUB_TOKEN
      - job-danger-js:
          name: Run Danger JS
          context:
            - cicd-orchestrator
      - job-test-apim-charts:
          name: Helm Chart - Lint & Test
          context:
            - cicd-orchestrator
      - job-validate-workflow-status:
          name: Validate workflow status
          requires:
            - Helm Chart - Lint & Test
orbs:
  keeper: gravitee-io/keeper@0.7.0
  aquasec: gravitee-io/aquasec@1.0.5
  helm: circleci/helm@3.0.0
  slack: circleci/slack@4.12.5
