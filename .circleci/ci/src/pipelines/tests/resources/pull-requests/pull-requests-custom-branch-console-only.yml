# This configuration has been automatically generated by the CircleCI Config SDK.
# For more information, see https://github.com/CircleCI-Public/circleci-config-sdk-ts
# SDK Version: 0.0.0-development

version: 2.1
setup: false
parameters:
  gio_action:
    type: string
    default: pull_requests
    description: ""
  dry_run:
    type: boolean
    default: true
    description: Run in dry run mode?
  docker_tag_as_latest:
    type: boolean
    default: false
    description: Is this version the latest version available?
  graviteeio_version:
    type: string
    default: ""
    description: Version of APIM to be used in docker images
  apim_version_path:
    type: string
    default: /home/circleci/project/pom.xml
    description: Path to pom.xml with APIM version
commands:
  cmd-webui-install:
    parameters:
      apim-ui-project:
        type: string
        default: ""
        description: the name of the UI project to build
    steps:
      - restore_cache:
          name: Restore NPM cache
          keys:
            - << parameters.apim-ui-project >>-cache-v1-{{ .Branch }}-{{ checksum "<< parameters.apim-ui-project >>/package-lock.json" }}
            - << parameters.apim-ui-project >>-cache-v1-{{ .Branch }}
      - run:
          name: Install dependencies
          command: npm install
          working_directory: << parameters.apim-ui-project >>
      - save_cache:
          name: Save NPM cache
          key: << parameters.apim-ui-project >>-cache-v1-{{ .Branch }}-{{ checksum "<< parameters.apim-ui-project >>/package-lock.json" }}
          paths:
            - ./<< parameters.apim-ui-project >>/node_modules
  cmd-notify-on-failure:
    steps:
      - keeper/env-export:
          secret-url: keeper://ZOz4db245GNaETVwmPBk8w/field/password
          var-name: SLACK_ACCESS_TOKEN
      - slack/notify:
          channel: C02JENTV2AX
          branch_pattern: master,[0-9]+\.[0-9]+\.x
          event: fail
          template: basic_fail_1
  cmd-create-docker-context:
    steps:
      - run:
          name: Create docker context for buildx
          command: |-
            docker context create tls-env
            docker buildx create tls-env --use
  cmd-docker-azure-login:
    steps:
      - keeper/env-export:
          secret-url: keeper://Q721P2LSOPJ9qiXLuf5AHQ/field/login
          var-name: AZURE_DOCKER_REGISTRY_USERNAME
      - keeper/env-export:
          secret-url: keeper://Q721P2LSOPJ9qiXLuf5AHQ/field/password
          var-name: AZURE_DOCKER_REGISTRY_PASSWORD
      - run:
          name: Login to Azure Container Registry
          command: echo $AZURE_DOCKER_REGISTRY_PASSWORD | docker login --username $AZURE_DOCKER_REGISTRY_USERNAME --password-stdin graviteeio.azurecr.io
    description: Login to Azure Container Registry
  cmd-docker-azure-logout:
    steps:
      - run:
          name: Logout from Azure Container Registry
          command: docker logout graviteeio.azurecr.io
    description: Logout from Azure Container Registry
  cmd-build-ui-image:
    parameters:
      docker-image-name:
        type: string
        default: ""
        description: the name of the image
      apim-ui-project:
        type: string
        default: ""
        description: the name of the UI project to build
    steps:
      - cmd-create-docker-context
      - cmd-docker-azure-login
      - run:
          name: Build UI docker image
          command: |-
            docker buildx build --push --platform=linux/arm64,linux/amd64 -f docker/Dockerfile \
            -t graviteeio.azurecr.io/<< parameters.docker-image-name >>:apim-1234-my-custom-branch-latest \
            .
          working_directory: << parameters.apim-ui-project >>
      - cmd-docker-azure-logout
  cmd-restore-maven-job-cache:
    parameters:
      jobName:
        type: string
        default: ""
        description: The job name
    steps:
      - restore_cache:
          keys:
            - gravitee-api-management-v9-<< parameters.jobName >>-{{ .Branch }}-{{ checksum "pom.xml" }}
            - gravitee-api-management-v9-<< parameters.jobName >>-{{ .Branch }}
    description: Restore Maven cache for a dedicated job
  cmd-save-maven-job-cache:
    parameters:
      jobName:
        type: string
        default: ""
        description: The job name
    steps:
      - run:
          name: Exclude all APIM artefacts from cache.
          command: rm -rf ~/.m2/repository/io/gravitee/apim
      - save_cache:
          key: gravitee-api-management-v9-<< parameters.jobName >>-{{ .Branch }}-{{ checksum "pom.xml" }}
          paths:
            - ~/.m2
          when: always
    description: Save Maven cache for a dedicated job
jobs:
  job-webui-lint-test:
    parameters:
      apim-ui-project:
        type: string
        default: ""
        description: the name of the UI project to build
      resource_class:
        type: string
        default: medium
        description: Resource class to use for executor
      node_version:
        type: string
        default: "16.10"
        description: Node version to use for executor
    docker:
      - image: cimg/node:<< parameters.node_version >>
    resource_class: << parameters.resource_class >>
    steps:
      - checkout
      - cmd-webui-install:
          apim-ui-project: << parameters.apim-ui-project >>
      - attach_workspace:
          at: .
      - run:
          name: Check License
          command: npm run lint:license
          working_directory: << parameters.apim-ui-project >>
      - run:
          name: Run Prettier and ESLint
          command: npm run lint
          working_directory: << parameters.apim-ui-project >>
      - run:
          name: Run unit tests
          command: npm run test:coverage
          working_directory: << parameters.apim-ui-project >>
      - cmd-notify-on-failure
      - persist_to_workspace:
          root: .
          paths:
            - << parameters.apim-ui-project >>/coverage/lcov.info
      - store_artifacts:
          path: << parameters.apim-ui-project >>/coverage/lcov.info
      - store_test_results:
          path: << parameters.apim-ui-project >>/coverage/junit.xml
  job-webui-build:
    parameters:
      apim-ui-project:
        type: string
        default: ""
        description: the name of the UI project to build
      docker-image-name:
        type: string
        default: ""
        description: the name of the image
      node_version:
        type: string
        default: "16.10"
        description: Node version to use for executor
    docker:
      - image: cimg/node:<< parameters.node_version >>
    resource_class: large
    steps:
      - checkout
      - attach_workspace:
          at: .
      - setup_remote_docker:
          version: 20.10.6
      - cmd-webui-install:
          apim-ui-project: << parameters.apim-ui-project >>
      - run:
          name: Update Build version
          command: "sed -i 's/\"version\": \".*\"/\"version\": \"4.2.0\"/' << parameters.apim-ui-project >>/build.json"
      - run:
          name: Build
          command: npm run build:prod
          environment:
            NODE_OPTIONS: --max_old_space_size=4086
          working_directory: << parameters.apim-ui-project >>
      - cmd-build-ui-image:
          docker-image-name: << parameters.docker-image-name >>
          apim-ui-project: << parameters.apim-ui-project >>
      - cmd-notify-on-failure
      - persist_to_workspace:
          root: .
          paths:
            - << parameters.apim-ui-project >>/dist
  job-console-webui-build-storybook:
    docker:
      - image: cimg/node:16.10
    resource_class: large
    steps:
      - checkout
      - cmd-webui-install:
          apim-ui-project: gravitee-apim-console-webui
      - run:
          name: Build
          command: npm run build-storybook
          working_directory: gravitee-apim-console-webui
          environment:
            NODE_OPTIONS: --max_old_space_size=3072
      - cmd-notify-on-failure
      - persist_to_workspace:
          root: .
          paths:
            - gravitee-apim-console-webui/storybook-static
  job-console-webui-chromatic-deployment:
    docker:
      - image: cimg/node:16.10
    resource_class: small
    steps:
      - checkout
      - attach_workspace:
          at: .
      - cmd-webui-install:
          apim-ui-project: gravitee-apim-console-webui
      - keeper/env-export:
          secret-url: keeper://TIlcGPFq4rN5GvgnZb9hng/field/password
          var-name: GITHUB_TOKEN
      - keeper/env-export:
          secret-url: keeper://Hp1bFl5s0doxnQgqkMdCdg/field/password
          var-name: CHROMATIC_PROJECT_TOKEN
      - run:
          name: Running Chromatic
          command: |-
            SB_URL=$(cd gravitee-apim-console-webui && npx chromatic --project-token=$CHROMATIC_PROJECT_TOKEN --exit-once-uploaded -d=storybook-static | grep -o "View your Storybook at https:\/\/[0-9a-z-]*\.chromatic\.com" | grep -o "https:.*")
            echo "export SB_URL=$SB_URL" >> $BASH_ENV
      - gh/setup
      - run:
          name: Edit Pull Request Description
          command: |-
            # First check there is an associated pull request, otherwise just stop the job here
            if ! gh pr view --json title;
            then
              echo "No PR found for this branch, stopping the job here."
              exit 0
            fi

            # If PR state is different from OPEN
            if [ "$(gh pr view --json state --jq .state)" != "OPEN" ];
            then
              echo "PR is not opened, stopping the job here."
              exit 0
            fi

            export PR_BODY_STORYBOOK_SECTION="
            <!-- Storybook placeholder -->
            ---

            ðŸ“š&nbsp;&nbsp;View the storybook of this branch [here](${SB_URL})
            <!-- Storybook placeholder end -->
            "

            export CLEAN_BODY=$(gh pr view --json body --jq .body | sed '/Storybook placeholder -->/,/Storybook placeholder end -->/d')

            gh pr edit --body "$CLEAN_BODY$PR_BODY_STORYBOOK_SECTION"
      - cmd-notify-on-failure
  job-sonarcloud-analysis:
    parameters:
      working_directory:
        type: string
        default: gravitee-apim-rest-api
        description: Directory where the Sonarcloud analysis will be run
      cache_type:
        type: enum
        default: backend
        description: Type of cache to use
        enum:
          - backend
          - frontend
    docker:
      - image: sonarsource/sonar-scanner-cli:5.0.1
    resource_class: large
    steps:
      - run:
          name: Add SSH tool
          command: apk add --no-cache openssh
      - checkout
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - gravitee-api-management-v9-sonarcloud-analysis-<< parameters.cache_type >>
      - keeper/env-export:
          secret-url: keeper://9x9YgyU6DWzux4DPoHAzDQ/field/password
          var-name: SONAR_TOKEN
      - run:
          name: Run Sonarcloud Analysis
          command: sonar-scanner -Dsonar.projectVersion=4.2.0
          working_directory: << parameters.working_directory >>
      - cmd-notify-on-failure
      - save_cache:
          paths:
            - /opt/sonar-scanner/.sonar/cache
          key: gravitee-api-management-v9-sonarcloud-analysis-<< parameters.cache_type >>
          when: always
  job-validate-workflow-status:
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - run:
          name: Check workflow jobs
          command: echo "Congratulations! If you can read this, everything is OK"
workflows:
  pull_requests:
    jobs:
      - job-webui-lint-test:
          name: Lint & test APIM Console
          context:
            - cicd-orchestrator
          apim-ui-project: gravitee-apim-console-webui
          resource_class: large
      - job-webui-build:
          name: Build APIM Console and publish image
          context:
            - cicd-orchestrator
          apim-ui-project: gravitee-apim-console-webui
          docker-image-name: apim-management-ui
      - job-console-webui-build-storybook:
          name: Build Console Storybook
          context:
            - cicd-orchestrator
      - job-console-webui-chromatic-deployment:
          name: Deploy console in chromatic
          context:
            - cicd-orchestrator
          requires:
            - Build Console Storybook
      - job-sonarcloud-analysis:
          name: Sonar - gravitee-apim-console-webui
          context:
            - cicd-orchestrator
          requires:
            - Lint & test APIM Console
          working_directory: gravitee-apim-console-webui
          cache_type: frontend
      - job-validate-workflow-status:
          name: Validate workflow status
          requires:
            - Lint & test APIM Console
            - Build APIM Console and publish image
orbs:
  keeper: gravitee-io/keeper@0.6.3
  slack: circleci/slack@4.12.5
  gh: circleci/github-cli@1.0.5
