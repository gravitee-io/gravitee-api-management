# This configuration has been automatically generated by the CircleCI Config SDK.
# For more information, see https://github.com/CircleCI-Public/circleci-config-sdk-ts
# SDK Version: 0.0.0-development

version: 2.1
setup: false
parameters:
  gio_action:
    type: string
    default: pull_requests
    description: ""
  dry_run:
    type: boolean
    default: true
    description: Run in dry run mode?
  docker_tag_as_latest:
    type: boolean
    default: false
    description: Is this version the latest version available?
  graviteeio_version:
    type: string
    default: ""
    description: Version of APIM to be used in docker images
  apim_version_path:
    type: string
    default: /home/circleci/project/pom.xml
    description: Path to pom.xml with APIM version
commands:
  cmd-restore-maven-job-cache:
    parameters:
      jobName:
        type: string
        default: ""
        description: The job name
    steps:
      - restore_cache:
          keys:
            - gravitee-api-management-v9-<< parameters.jobName >>-{{ .Branch }}-{{ checksum "pom.xml" }}
            - gravitee-api-management-v9-<< parameters.jobName >>-{{ .Branch }}
    description: Restore Maven cache for a dedicated job
  cmd-save-maven-job-cache:
    parameters:
      jobName:
        type: string
        default: ""
        description: The job name
    steps:
      - run:
          name: Exclude all APIM artefacts from cache.
          command: rm -rf ~/.m2/repository/io/gravitee/apim
      - save_cache:
          key: gravitee-api-management-v9-<< parameters.jobName >>-{{ .Branch }}-{{ checksum "pom.xml" }}
          paths:
            - ~/.m2
          when: always
    description: Save Maven cache for a dedicated job
  cmd-notify-on-failure:
    steps:
      - keeper/env-export:
          secret-url: keeper://ZOz4db245GNaETVwmPBk8w/field/password
          var-name: SLACK_ACCESS_TOKEN
      - slack/notify:
          channel: C02JENTV2AX
          branch_pattern: master,[0-9]+\.[0-9]+\.x
          event: fail
          template: basic_fail_1
  cmd-webui-install:
    parameters:
      apim-ui-project:
        type: string
        default: ""
        description: the name of the UI project to build
    steps:
      - restore_cache:
          name: Restore NPM cache
          keys:
            - << parameters.apim-ui-project >>-cache-v1-{{ .Branch }}-{{ checksum "<< parameters.apim-ui-project >>/package-lock.json" }}
            - << parameters.apim-ui-project >>-cache-v1-{{ .Branch }}
      - run:
          name: Install dependencies
          command: npm install
          working_directory: << parameters.apim-ui-project >>
      - save_cache:
          name: Save NPM cache
          key: << parameters.apim-ui-project >>-cache-v1-{{ .Branch }}-{{ checksum "<< parameters.apim-ui-project >>/package-lock.json" }}
          paths:
            - ./<< parameters.apim-ui-project >>/node_modules
  cmd-create-docker-context:
    steps:
      - run:
          name: Create docker context for buildx
          command: |-
            docker context create tls-env
            docker buildx create tls-env --use
  cmd-docker-azure-login:
    steps:
      - keeper/env-export:
          secret-url: keeper://Q721P2LSOPJ9qiXLuf5AHQ/field/login
          var-name: AZURE_DOCKER_REGISTRY_USERNAME
      - keeper/env-export:
          secret-url: keeper://Q721P2LSOPJ9qiXLuf5AHQ/field/password
          var-name: AZURE_DOCKER_REGISTRY_PASSWORD
      - run:
          name: Login to Azure Container Registry
          command: echo $AZURE_DOCKER_REGISTRY_PASSWORD | docker login --username $AZURE_DOCKER_REGISTRY_USERNAME --password-stdin graviteeio.azurecr.io
    description: Login to Azure Container Registry
  cmd-docker-azure-logout:
    steps:
      - run:
          name: Logout from Azure Container Registry
          command: docker logout graviteeio.azurecr.io
    description: Logout from Azure Container Registry
  cmd-add-docker-image-in-snyk:
    parameters:
      docker-image-name:
        type: string
      version:
        type: string
    steps:
      - run:
          name: Add << parameters.docker-image-name >> << parameters.version >> to Snyk
          command: |-
            curl --fail \
                --include \
                --request POST \
                --header "Content-Type: application/json; charset=utf-8" \
                --header "Authorization: token ${SNYK_API_TOKEN}" \
                --data-binary "{
              \"target\": {
                \"name\": \"<< parameters.docker-image-name >>:<< parameters.version >>\"
              }
            }" \
            "https://api.snyk.io/api/v1/org/${SNYK_ORG_ID}/integrations/${SNYK_INTEGRATION_ID}/import"
  cmd-build-ui-image:
    parameters:
      docker-image-name:
        type: string
        default: ""
        description: the name of the image
      apim-ui-project:
        type: string
        default: ""
        description: the name of the UI project to build
    steps:
      - cmd-create-docker-context
      - cmd-docker-azure-login
      - run:
          name: Build UI docker image
          command: |-
            docker buildx build --push --platform=linux/arm64,linux/amd64 -f docker/Dockerfile \
            -t graviteeio.azurecr.io/<< parameters.docker-image-name >>:4.1.x-latest \
            .
          working_directory: << parameters.apim-ui-project >>
      - keeper/env-export:
          secret-url: keeper://s83JmReKpBZWjHdud6ZAlg/custom_field/gravitee_apim_org_api_token
          var-name: SNYK_API_TOKEN
      - keeper/env-export:
          secret-url: keeper://s83JmReKpBZWjHdud6ZAlg/custom_field/gravitee_apim_org_id
          var-name: SNYK_ORG_ID
      - keeper/env-export:
          secret-url: keeper://s83JmReKpBZWjHdud6ZAlg/custom_field/gravitee_apim_acr_integration_id
          var-name: SNYK_INTEGRATION_ID
      - cmd-add-docker-image-in-snyk:
          docker-image-name: << parameters.docker-image-name >>
          version: 4.1.x-latest
      - cmd-docker-azure-logout
jobs:
  job-test-apim-charts:
    parameters:
      helmClientVersion:
        type: string
        default: v3.12.3
        description: Version of helm to test
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - checkout
      - helm/install_helm_client:
          version: << parameters.helmClientVersion >>
      - run:
          name: Install helm-unittest plugin
          command: helm plugin install https://github.com/helm-unittest/helm-unittest.git --version 0.5.1
      - run:
          name: Lint the helm charts available in helm/
          command: helm lint helm/
      - run:
          name: Execute the units tests in helm/
          command: helm unittest -f 'tests/**/*.yaml' helm/ -t JUnit -o apim-result.xml
      - store_test_results:
          path: apim-result.xml
  job-setup:
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - checkout
      - keeper/env-export:
          secret-url: keeper://7CgijuGiFDSLynRJt1Dm9w/custom_field/xml
          var-name: MAVEN_SETTINGS
      - run:
          command: "echo $MAVEN_SETTINGS > .gravitee.settings.xml "
      - persist_to_workspace:
          root: .
          paths:
            - .gravitee.settings.xml
  job-validate:
    docker:
      - image: cimg/openjdk:17.0.8
    resource_class: small
    steps:
      - checkout
      - attach_workspace:
          at: .
      - cmd-restore-maven-job-cache:
          jobName: job-validate
      - run:
          name: Validate project
          command: mvn -s .gravitee.settings.xml validate --no-transfer-progress -Pall-modules,integration-tests-modules -T 2C
      - cmd-notify-on-failure
      - cmd-save-maven-job-cache:
          jobName: job-validate
  job-danger-js:
    docker:
      - image: cimg/node:16.13
    resource_class: small
    steps:
      - checkout
      - keeper/env-export:
          secret-url: keeper://TIlcGPFq4rN5GvgnZb9hng/field/password
          var-name: DANGER_GITHUB_API_TOKEN
      - run:
          name: Run Danger JS
          command: cd .circleci/danger && yarn run danger
  job-build:
    docker:
      - image: cimg/openjdk:17.0.8
    resource_class: large
    steps:
      - checkout
      - attach_workspace:
          at: .
      - cmd-restore-maven-job-cache:
          jobName: job-build
      - run:
          name: Build project
          command: |-
            mvn -s .gravitee.settings.xml clean install --no-transfer-progress --update-snapshots -DskipTests -Dskip.validation=true -T 2C -Dbundle=dev
            mkdir -p ./rest-api-docker-context/distribution && cp -r ./gravitee-apim-rest-api/gravitee-apim-rest-api-standalone/gravitee-apim-rest-api-standalone-distribution/target/distribution ./rest-api-docker-context/.
            mkdir -p ./gateway-docker-context/distribution && cp -r ./gravitee-apim-gateway/gravitee-apim-gateway-standalone/gravitee-apim-gateway-standalone-distribution/target/distribution ./gateway-docker-context/.
          environment:
            BUILD_ID: "1234"
            BUILD_NUMBER: "1234"
            GIT_COMMIT: 784ff35ca
      - cmd-notify-on-failure
      - save_cache:
          paths:
            - ~/.m2/repository/io/gravitee/apim
          key: gravitee-api-management-v9-build-apim-{{ .Environment.CIRCLE_WORKFLOW_WORKSPACE_ID }}
          when: on_success
      - cmd-save-maven-job-cache:
          jobName: job-build
      - persist_to_workspace:
          root: ./
          paths:
            - ./gravitee-apim-rest-api/gravitee-apim-rest-api-management/gravitee-apim-rest-api-management-rest/target/classes/console-openapi.*
            - ./rest-api-docker-context
            - ./gateway-docker-context
  job-test-definition:
    docker:
      - image: cimg/openjdk:17.0.8
    resource_class: small
    steps:
      - checkout
      - attach_workspace:
          at: .
      - cmd-restore-maven-job-cache:
          jobName: job-test-definition
      - restore_cache:
          keys:
            - gravitee-api-management-v9-build-apim-{{ .Environment.CIRCLE_WORKFLOW_WORKSPACE_ID }}
      - run:
          name: Run definition tests
          command: mvn --fail-fast -s .gravitee.settings.xml test --no-transfer-progress -Ddefinition-modules -Dskip.validation=true -T 2C
      - run:
          name: Save test results
          command: |-
            mkdir -p ~/test-results/junit/
            find . -type f -regex ".*/target/surefire-reports/.*xml" -exec cp {} ~/test-results/junit/ \;
          when: always
      - cmd-notify-on-failure
      - cmd-save-maven-job-cache:
          jobName: job-test-definition
      - store_test_results:
          path: ~/test-results
      - persist_to_workspace:
          root: .
          paths:
            - gravitee-apim-definition/gravitee-apim-definition-coverage/target/site/jacoco-aggregate/
  job-sonarcloud-analysis:
    parameters:
      working_directory:
        type: string
        default: gravitee-apim-rest-api
        description: Directory where the Sonarcloud analysis will be run
      cache_type:
        type: enum
        default: backend
        description: Type of cache to use
        enum:
          - backend
          - frontend
    docker:
      - image: sonarsource/sonar-scanner-cli:5.0.1
    resource_class: large
    steps:
      - run:
          name: Add SSH tool
          command: apk add --no-cache openssh
      - checkout
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - gravitee-api-management-v9-sonarcloud-analysis-<< parameters.cache_type >>
      - keeper/env-export:
          secret-url: keeper://9x9YgyU6DWzux4DPoHAzDQ/field/password
          var-name: SONAR_TOKEN
      - run:
          name: Run Sonarcloud Analysis
          command: sonar-scanner -Dsonar.projectVersion=4.2.0
          working_directory: << parameters.working_directory >>
      - cmd-notify-on-failure
      - save_cache:
          paths:
            - /opt/sonar-scanner/.sonar/cache
          key: gravitee-api-management-v9-sonarcloud-analysis-<< parameters.cache_type >>
          when: always
  job-test-gateway:
    docker:
      - image: cimg/openjdk:17.0.8
    resource_class: medium
    steps:
      - checkout
      - attach_workspace:
          at: .
      - cmd-restore-maven-job-cache:
          jobName: job-test-gateway
      - restore_cache:
          keys:
            - gravitee-api-management-v9-build-apim-{{ .Environment.CIRCLE_WORKFLOW_WORKSPACE_ID }}
      - run:
          name: Run gateway tests
          command: mvn --fail-fast -s .gravitee.settings.xml test --no-transfer-progress -Dgateway-modules -Dskip.validation=true -T 2C
      - run:
          name: Save test results
          command: |-
            mkdir -p ~/test-results/junit/
            find . -type f -regex ".*/target/surefire-reports/.*xml" -exec cp {} ~/test-results/junit/ \;
          when: always
      - cmd-notify-on-failure
      - cmd-save-maven-job-cache:
          jobName: job-test-gateway
      - store_test_results:
          path: ~/test-results
      - persist_to_workspace:
          root: .
          paths:
            - gravitee-apim-gateway/gravitee-apim-gateway-coverage/target/site/jacoco-aggregate/
  job-test-rest-api:
    docker:
      - image: cimg/openjdk:17.0.8
    resource_class: medium
    steps:
      - checkout
      - attach_workspace:
          at: .
      - cmd-restore-maven-job-cache:
          jobName: job-test-rest-api
      - restore_cache:
          keys:
            - gravitee-api-management-v9-build-apim-{{ .Environment.CIRCLE_WORKFLOW_WORKSPACE_ID }}
      - run:
          name: Run Rest API tests
          command: mvn --fail-fast -s .gravitee.settings.xml test --no-transfer-progress -Drest-api-modules -Dskip.validation=true -T 2C
      - run:
          name: Save test results
          command: |-
            mkdir -p ~/test-results/junit/
            find . -type f -regex ".*/target/surefire-reports/.*xml" -exec cp {} ~/test-results/junit/ \;
          when: always
      - cmd-notify-on-failure
      - cmd-save-maven-job-cache:
          jobName: job-test-rest-api
      - store_test_results:
          path: ~/test-results
      - persist_to_workspace:
          root: .
          paths:
            - gravitee-apim-rest-api/gravitee-apim-rest-api-coverage/target/site/jacoco-aggregate/
  job-test-integration:
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: false
    resource_class: medium
    steps:
      - checkout
      - attach_workspace:
          at: .
      - cmd-restore-maven-job-cache:
          jobName: job-test-integration
      - restore_cache:
          keys:
            - gravitee-api-management-v9-build-apim-{{ .Environment.CIRCLE_WORKFLOW_WORKSPACE_ID }}
      - run:
          name: Run tests
          command: |-
            cd gravitee-apim-integration-tests
            # List all tests
            circleci tests glob "src/test/java/**/*Test.java" | sed -e 's#^src/test/java/\(.*\)\.java#\1#' | tr "/" "." > all-tests

            # List all tests to run on this executor
            cat all-tests | circleci tests split --split-by=timings --timings-type=classname --time-default=10s > tests-to-run

            # Compute exclusion list (use grep to invert the include list to an exclude list)
            cat all-tests | grep -xvf tests-to-run > /tmp/ignore_list

            # Add * add the end of each line of ignore_list to also exclude all inner classes
            sed -i 's/$/*/' /tmp/ignore_list

            # Display tests to run on this executor
            echo "Following test files will run on this executor:"
            cat tests-to-run

            # Run tests with rerunFailingTestsCount=2 because some integration tests related to RabbitMQ or Websocket are randomly failing on the CI
            mvn --fail-fast -s ../.gravitee.settings.xml test --no-transfer-progress -Dskip.validation=true -Dsurefire.excludesFile=/tmp/ignore_list -Dsurefire.rerunFailingTestsCount=2
      - run:
          name: Save test results
          command: |-
            mkdir -p ~/test-results/junit/
            find . -type f -regex ".*/target/surefire-reports/.*xml" -exec cp {} ~/test-results/junit/ \;
          when: always
      - cmd-notify-on-failure
      - cmd-save-maven-job-cache:
          jobName: job-test-integration
      - store_test_results:
          path: ~/test-results
    parallelism: 4
  job-test-plugin:
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: false
    resource_class: medium
    steps:
      - checkout
      - attach_workspace:
          at: .
      - cmd-restore-maven-job-cache:
          jobName: job-test-plugin
      - restore_cache:
          keys:
            - gravitee-api-management-v9-build-apim-{{ .Environment.CIRCLE_WORKFLOW_WORKSPACE_ID }}
      - run:
          name: Run plugin tests
          command: mvn --fail-fast -s .gravitee.settings.xml test --no-transfer-progress -Dplugin-modules -Dskip.validation=true -T 2C
      - run:
          name: Save test results
          command: |-
            mkdir -p ~/test-results/junit/
            find . -type f -regex ".*/target/surefire-reports/.*xml" -exec cp {} ~/test-results/junit/ \;
          when: always
      - cmd-notify-on-failure
      - cmd-save-maven-job-cache:
          jobName: job-test-plugin
      - store_test_results:
          path: ~/test-results
      - persist_to_workspace:
          root: .
          paths:
            - gravitee-apim-plugin/gravitee-apim-plugin-coverage/target/site/jacoco-aggregate/
  job-test-repository:
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: false
    resource_class: large
    steps:
      - checkout
      - attach_workspace:
          at: .
      - cmd-restore-maven-job-cache:
          jobName: job-test-repository
      - restore_cache:
          keys:
            - gravitee-api-management-v9-build-apim-{{ .Environment.CIRCLE_WORKFLOW_WORKSPACE_ID }}
      - run:
          name: Run repository tests
          command: mvn --fail-fast -s .gravitee.settings.xml verify --no-transfer-progress -Drepository-modules -Dskip.validation=true -T 2C
      - run:
          name: Save test results
          command: |-
            mkdir -p ~/test-results/junit/
            find . -type f -regex ".*/target/surefire-reports/.*xml" -exec cp {} ~/test-results/junit/ \;
          when: always
      - cmd-notify-on-failure
      - cmd-save-maven-job-cache:
          jobName: job-test-repository
      - store_test_results:
          path: ~/test-results
      - persist_to_workspace:
          root: .
          paths:
            - gravitee-apim-repository/gravitee-apim-repository-coverage/target/site/jacoco-aggregate/
  job-webui-lint-test:
    parameters:
      apim-ui-project:
        type: string
        default: ""
        description: the name of the UI project to build
      resource_class:
        type: string
        default: medium
        description: Resource class to use for executor
      node_version:
        type: string
        default: "20.11"
        description: Node version to use for executor
    docker:
      - image: cimg/node:<< parameters.node_version >>
    resource_class: << parameters.resource_class >>
    steps:
      - checkout
      - cmd-webui-install:
          apim-ui-project: << parameters.apim-ui-project >>
      - attach_workspace:
          at: .
      - run:
          name: Check License
          command: npm run lint:license
          working_directory: << parameters.apim-ui-project >>
      - run:
          name: Run Prettier and ESLint
          command: npm run lint
          working_directory: << parameters.apim-ui-project >>
      - run:
          name: Run unit tests
          command: npm run test:coverage
          working_directory: << parameters.apim-ui-project >>
      - cmd-notify-on-failure
      - persist_to_workspace:
          root: .
          paths:
            - << parameters.apim-ui-project >>/coverage/lcov.info
      - store_artifacts:
          path: << parameters.apim-ui-project >>/coverage/lcov.info
      - store_test_results:
          path: << parameters.apim-ui-project >>/coverage/junit.xml
  job-webui-build:
    parameters:
      apim-ui-project:
        type: string
        default: ""
        description: the name of the UI project to build
      docker-image-name:
        type: string
        default: ""
        description: the name of the image
      node_version:
        type: string
        default: "20.11"
        description: Node version to use for executor
    docker:
      - image: cimg/node:<< parameters.node_version >>
    resource_class: large
    steps:
      - checkout
      - attach_workspace:
          at: .
      - setup_remote_docker:
          version: default
      - cmd-webui-install:
          apim-ui-project: << parameters.apim-ui-project >>
      - run:
          name: Update Build version
          command: "sed -i 's/\"version\": \".*\"/\"version\": \"4.2.0\"/' << parameters.apim-ui-project >>/build.json"
      - run:
          name: Build
          command: npm run build:prod
          environment:
            NODE_OPTIONS: --max_old_space_size=4086
          working_directory: << parameters.apim-ui-project >>
      - cmd-build-ui-image:
          docker-image-name: << parameters.docker-image-name >>
          apim-ui-project: << parameters.apim-ui-project >>
      - cmd-notify-on-failure
      - persist_to_workspace:
          root: .
          paths:
            - << parameters.apim-ui-project >>/dist
  job-console-webui-build-storybook:
    parameters:
      node_version:
        type: string
        default: "20.11"
        description: Node version to use for executor
    docker:
      - image: cimg/node:<< parameters.node_version >>
    resource_class: large
    steps:
      - checkout
      - cmd-webui-install:
          apim-ui-project: gravitee-apim-console-webui
      - run:
          name: Build
          command: npm run build-storybook
          working_directory: gravitee-apim-console-webui
          environment:
            NODE_OPTIONS: --max_old_space_size=8192
      - cmd-notify-on-failure
      - persist_to_workspace:
          root: .
          paths:
            - gravitee-apim-console-webui/storybook-static
  job-console-webui-chromatic-deployment:
    parameters:
      node_version:
        type: string
        default: "20.11"
        description: Node version to use for executor
    docker:
      - image: cimg/node:<< parameters.node_version >>
    resource_class: small
    steps:
      - checkout
      - attach_workspace:
          at: .
      - cmd-webui-install:
          apim-ui-project: gravitee-apim-console-webui
      - keeper/env-export:
          secret-url: keeper://TIlcGPFq4rN5GvgnZb9hng/field/password
          var-name: GITHUB_TOKEN
      - keeper/env-export:
          secret-url: keeper://Hp1bFl5s0doxnQgqkMdCdg/field/password
          var-name: CHROMATIC_PROJECT_TOKEN
      - run:
          name: Running Chromatic
          command: |-
            SB_URL=$(cd gravitee-apim-console-webui && npx chromatic --project-token=$CHROMATIC_PROJECT_TOKEN --exit-once-uploaded -d=storybook-static | grep -o "View your Storybook at https:\/\/[0-9a-z-]*\.chromatic\.com" | grep -o "https:.*")
            echo "export SB_URL=$SB_URL" >> $BASH_ENV
      - gh/setup
      - run:
          name: Edit Pull Request Description
          command: |-
            # First check there is an associated pull request, otherwise just stop the job here
            if ! gh pr view --json title;
            then
              echo "No PR found for this branch, stopping the job here."
              exit 0
            fi

            # If PR state is different from OPEN
            if [ "$(gh pr view --json state --jq .state)" != "OPEN" ];
            then
              echo "PR is not opened, stopping the job here."
              exit 0
            fi

            export PR_BODY_STORYBOOK_SECTION="
            <!-- Storybook placeholder -->
            ---

            ðŸ“š&nbsp;&nbsp;View the storybook of this branch [here](${SB_URL})
            <!-- Storybook placeholder end -->
            "

            export CLEAN_BODY=$(gh pr view --json body --jq .body | sed '/Storybook placeholder -->/,/Storybook placeholder end -->/d')

            gh pr edit --body "$CLEAN_BODY$PR_BODY_STORYBOOK_SECTION"
      - cmd-notify-on-failure
  job-build-images:
    docker:
      - image: cimg/openjdk:17.0.8
    resource_class: medium
    steps:
      - checkout
      - attach_workspace:
          at: .
      - setup_remote_docker:
          version: default
      - cmd-create-docker-context
      - cmd-docker-azure-login
      - run:
          name: Build rest api and gateway docker images
          command: |-
            docker buildx build --push --platform=linux/arm64,linux/amd64 -f gravitee-apim-rest-api/docker/Dockerfile \
            -t graviteeio.azurecr.io/apim-management-api:4.1.x-latest \
            rest-api-docker-context

            docker buildx build --push --platform=linux/arm64,linux/amd64 -f gravitee-apim-gateway/docker/Dockerfile \
            -t graviteeio.azurecr.io/apim-gateway:4.1.x-latest \
            gateway-docker-context
      - keeper/env-export:
          secret-url: keeper://s83JmReKpBZWjHdud6ZAlg/custom_field/gravitee_apim_org_api_token
          var-name: SNYK_API_TOKEN
      - keeper/env-export:
          secret-url: keeper://s83JmReKpBZWjHdud6ZAlg/custom_field/gravitee_apim_org_id
          var-name: SNYK_ORG_ID
      - keeper/env-export:
          secret-url: keeper://s83JmReKpBZWjHdud6ZAlg/custom_field/gravitee_apim_acr_integration_id
          var-name: SNYK_INTEGRATION_ID
      - cmd-add-docker-image-in-snyk:
          docker-image-name: apim-management-api
          version: 4.1.x-latest
      - cmd-add-docker-image-in-snyk:
          docker-image-name: apim-gateway
          version: 4.1.x-latest
      - cmd-docker-azure-logout
  job-e2e-generate-sdk:
    docker:
      - image: cimg/openjdk:17.0.8-node
    resource_class: small
    steps:
      - checkout
      - cmd-webui-install:
          apim-ui-project: gravitee-apim-e2e
      - attach_workspace:
          at: .
      - run:
          name: Generate e2e tests SDK
          command: |-
            npm run update:sdk:management
            npm run update:sdk:management:v2
            npm run update:sdk:portal
          working_directory: gravitee-apim-e2e
      - cmd-notify-on-failure
      - persist_to_workspace:
          root: .
          paths:
            - gravitee-apim-e2e/lib/management-webclient-sdk
            - gravitee-apim-e2e/lib/management-v2-webclient-sdk
            - gravitee-apim-e2e/lib/portal-webclient-sdk
  job-e2e-lint-build:
    docker:
      - image: cimg/node:16.13
    resource_class: small
    steps:
      - checkout
      - cmd-webui-install:
          apim-ui-project: gravitee-apim-e2e
      - attach_workspace:
          at: .
      - run:
          name: Check License
          command: npm run lint:license
          working_directory: gravitee-apim-e2e
      - run:
          name: Run Prettier and ESLint
          command: npm run lint
          working_directory: gravitee-apim-e2e
      - run:
          name: Build
          command: npm run build
          working_directory: gravitee-apim-e2e
      - cmd-notify-on-failure
      - persist_to_workspace:
          root: .
          paths:
            - gravitee-apim-e2e/dist
            - gravitee-apim-e2e/node_modules
  job-e2e-test:
    parameters:
      apim_client_tag:
        type: string
        default: ""
      execution_mode:
        type: string
        default: ""
      database:
        type: string
        default: ""
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: false
    resource_class: medium
    steps:
      - checkout
      - attach_workspace:
          at: .
      - cmd-docker-azure-login
      - keeper/env-export:
          secret-url: keeper://w8WBpALVCgYdxtV5pVrQsw/custom_field/base64
          var-name: GRAVITEE_LICENSE
      - run:
          name: Running API & E2E tests in << parameters.execution_mode >> mode with << parameters.database >> database
          command: |-
            cd gravitee-apim-e2e
            if [ "<< parameters.execution_mode >>" = "v3" ]; then
              echo "Disable v4 emulation engine on APIM Gateway and Rest API"
              export V4_EMULATION_ENGINE_DEFAULT=no
            fi
            if [ -z "<< parameters.apim_client_tag >>" ]; then
              APIM_REGISTRY=graviteeio.azurecr.io APIM_TAG=4.1.x-latest APIM_CLIENT_REGISTRY=graviteeio.azurecr.io APIM_CLIENT_TAG=4.1.x-latest npm run test:api:<< parameters.database >>
            else 
              if [[ "<< parameters.apim_client_tag >>" == *"@"* ]]; then
                echo "Using custom registry for client"
                CLIENT_REGISTRY=$(echo "<< parameters.apim_client_tag >>" | cut -f1 -d@)
                CLIENT_TAG=$(echo "<< parameters.apim_client_tag >>" | cut -f2 -d@)
                APIM_REGISTRY=graviteeio.azurecr.io APIM_TAG=4.1.x-latest APIM_CLIENT_REGISTRY=${CLIENT_REGISTRY} APIM_CLIENT_TAG=${CLIENT_TAG} npm run test:api:<< parameters.database >>
              else
                echo "Using ACR registry for client"
                APIM_REGISTRY=graviteeio.azurecr.io APIM_TAG=4.1.x-latest APIM_CLIENT_REGISTRY=graviteeio.azurecr.io APIM_CLIENT_TAG=<< parameters.apim_client_tag >> npm run test:api:<< parameters.database >>
              fi
            fi
      - cmd-docker-azure-logout
      - cmd-notify-on-failure
      - store_test_results:
          path: ./gravitee-apim-e2e/.tmp/e2e-test-report.xml
      - store_artifacts:
          path: ./gravitee-apim-e2e/.tmp/e2e-test-report.xml
      - store_artifacts:
          path: ./gravitee-apim-e2e/.logs
  job-e2e-cypress:
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: false
    resource_class: large
    steps:
      - checkout
      - attach_workspace:
          at: .
      - cmd-docker-azure-login
      - keeper/env-export:
          secret-url: keeper://FVzylPCgY-LJsgjkW4q1eQ/field/password
          var-name: CYPRESS_CLOUD_KEY
      - run:
          name: Running UI tests
          command: |-
            cd gravitee-apim-e2e
            APIM_REGISTRY=graviteeio.azurecr.io APIM_TAG=4.1.x-latest npm run test:ui
      - cmd-docker-azure-logout
      - cmd-notify-on-failure
      - store_artifacts:
          path: ./gravitee-apim-e2e/.tmp/screenshots
      - store_artifacts:
          path: ./gravitee-apim-e2e/.tmp/videos
      - store_artifacts:
          path: ./gravitee-apim-e2e/.logs
  job-perf-lint-build:
    docker:
      - image: cimg/node:16.13
    resource_class: small
    steps:
      - checkout
      - cmd-webui-install:
          apim-ui-project: gravitee-apim-perf
      - attach_workspace:
          at: .
      - run:
          name: Check License
          command: npm run lint:license
          working_directory: gravitee-apim-perf
      - run:
          name: Run Prettier and ESLint
          command: npm run lint
          working_directory: gravitee-apim-perf
      - run:
          name: Build
          command: npm run build
          working_directory: gravitee-apim-perf
      - cmd-notify-on-failure
  job-community-build:
    docker:
      - image: cimg/openjdk:17.0.8
    resource_class: large
    steps:
      - checkout
      - cmd-restore-maven-job-cache:
          jobName: job-community-build
      - run:
          name: Build project
          command: mvn clean install --no-transfer-progress --update-snapshots -DskipTests -Dskip.validation=true -T 2C
      - cmd-notify-on-failure
      - cmd-save-maven-job-cache:
          jobName: job-community-build
  job-snyk-apim-charts:
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - checkout
      - keeper/env-export:
          secret-url: keeper://s83JmReKpBZWjHdud6ZAlg/custom_field/gravitee_apim_org_api_token
          var-name: SNYK_TOKEN
      - helm/install_helm_client:
          version: v3.12.3
      - snyk/install
      - run:
          name: Build the Charts ouput and scan
          command: |-
            helm dependency update
            helm template . --output-dir ./output
            snyk iac test ./output --report --target-reference="4.1.x" --project-tags=version=4.1.x --severity-threshold=high
          working_directory: ./helm
  job-publish-on-artifactory:
    docker:
      - image: cimg/openjdk:17.0.8
    resource_class: large
    steps:
      - checkout
      - attach_workspace:
          at: .
      - cmd-restore-maven-job-cache:
          jobName: job-publish-on-artifactory
      - run:
          name: Maven Package and deploy to Artifactory ([gravitee-snapshots] repository)
          command: mvn deploy --no-transfer-progress -DskipTests -Dskip.validation=true -T 2C -s .gravitee.settings.xml -U -P gio-artifactory-snapshot
      - cmd-notify-on-failure
      - cmd-save-maven-job-cache:
          jobName: job-publish-on-artifactory
  job-publish-on-nexus:
    docker:
      - image: cimg/openjdk:17.0.8
    resource_class: large
    steps:
      - checkout
      - attach_workspace:
          at: .
      - cmd-restore-maven-job-cache:
          jobName: job-publish-on-nexus
      - run:
          name: Maven Package and deploy to Nexus Snapshots
          command: mvn deploy --no-transfer-progress -DskipTests -Dskip.validation=true -T 2C -s .gravitee.settings.xml -U
      - cmd-notify-on-failure
      - cmd-save-maven-job-cache:
          jobName: job-publish-on-nexus
  job-release-helm:
    docker:
      - image: cimg/node:16.13
    resource_class: medium
    steps:
      - checkout
      - keeper/env-export:
          secret-url: keeper://IZd-yvsMopfQEa_0j1SDvg/field/login
          var-name: GIT_USER_NAME
      - keeper/env-export:
          secret-url: keeper://IZd-yvsMopfQEa_0j1SDvg/custom_field/email
          var-name: GIT_USER_EMAIL
      - keeper/env-export:
          secret-url: keeper://TIlcGPFq4rN5GvgnZb9hng/field/password
          var-name: GITHUB_TOKEN
      - add_ssh_keys:
          fingerprints:
            - ac:88:23:8f:c6:0f:7d:f0:fc:df:73:20:34:56:02:6c
      - run:
          name: Git config
          command: |-
            git config --global user.name "${GIT_USER_NAME}"
            git config --global user.email "${GIT_USER_EMAIL}"
      - gh/setup
      - helm/install_helm_client:
          version: v3.12.3
      - run:
          name: build the Charts
          working_directory: ./helm
          command: |-
            helm dependency update
            helm package -d charts .

            sed "s/name.*/name: apim3/" -i Chart.yaml
            helm package -d charts .
      - run:
          name: Install dependencies
          command: npm install
          working_directory: ./release
      - keeper/env-export:
          secret-url: keeper://Q721P2LSOPJ9qiXLuf5AHQ/field/login
          var-name: ACR_USER_NAME
      - keeper/env-export:
          secret-url: keeper://Q721P2LSOPJ9qiXLuf5AHQ/field/password
          var-name: ACR_PASSWORD
      - run:
          name: Publish helm chart release in azure repository DRY-RUN mode
          working_directory: ./helm
          command: |-
            helm registry login graviteeio.azurecr.io --username $ACR_USER_NAME --password $ACR_PASSWORD
            helm push charts/apim-*.tgz oci://graviteeio.azurecr.io/helm/
            helm push charts/apim3-*.tgz oci://graviteeio.azurecr.io/helm/
  job-deploy-on-azure-cluster:
    docker:
      - image: mcr.microsoft.com/azure-cli:2.34.1
    resource_class: large
    steps:
      - attach_workspace:
          at: .
      - keeper/env-export:
          secret-url: keeper://UryantA7MvZe8fkWwcUt8g/field/login
          var-name: AZURE_APPLICATION_ID
      - keeper/env-export:
          secret-url: keeper://UryantA7MvZe8fkWwcUt8g/custom_field/tenant
          var-name: AZURE_TENANT
      - keeper/env-export:
          secret-url: keeper://UryantA7MvZe8fkWwcUt8g/field/password
          var-name: AZURE_APPLICATION_SECRET
      - run:
          name: Install Kubectl
          command: |-
            curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
            chmod +x ./kubectl
            mv ./kubectl /usr/local/bin/kubectl
            kubectl version --client=true
      - run:
          name: Rollout pods on "gravitee-devs-preprod-aks-cluster"
          command: |-
            az login --service-principal -u $AZURE_APPLICATION_ID --tenant $AZURE_TENANT -p $AZURE_APPLICATION_SECRET
            az aks get-credentials --admin --resource-group Devs-Preprod-Hosted --name gravitee-devs-preprod-aks-cluster

            kubectl rollout restart deployment -n apim-apim-4-1-x
            kubectl rollout restart deployment -n apim-apim-4-1-x-ce
            kubectl rollout restart deployment -n apim-apim-4-1-x-oem
      - cmd-notify-on-failure
workflows:
  pull_requests:
    jobs:
      - job-test-apim-charts:
          name: Helm Chart - Lint & Test
      - job-setup:
          name: Setup
          context:
            - cicd-orchestrator
      - job-validate:
          name: Validate backend
          context:
            - cicd-orchestrator
          requires:
            - Setup
      - job-danger-js:
          name: Run Danger JS
          context:
            - cicd-orchestrator
          requires:
            - Validate backend
      - job-build:
          name: Build backend
          context:
            - cicd-orchestrator
          requires:
            - Validate backend
      - job-test-definition:
          name: Test definition
          context:
            - cicd-orchestrator
          requires:
            - Build backend
      - job-sonarcloud-analysis:
          name: Sonar - gravitee-apim-definition
          context:
            - cicd-orchestrator
          requires:
            - Test definition
          working_directory: gravitee-apim-definition
          cache_type: backend
      - job-test-gateway:
          name: Test gateway
          context:
            - cicd-orchestrator
          requires:
            - Build backend
      - job-sonarcloud-analysis:
          name: Sonar - gravitee-apim-gateway
          context:
            - cicd-orchestrator
          requires:
            - Test gateway
          working_directory: gravitee-apim-gateway
          cache_type: backend
      - job-test-rest-api:
          name: Test rest-api
          context:
            - cicd-orchestrator
          requires:
            - Build backend
      - job-sonarcloud-analysis:
          name: Sonar - gravitee-apim-rest-api
          context:
            - cicd-orchestrator
          requires:
            - Test rest-api
          working_directory: gravitee-apim-rest-api
          cache_type: backend
      - job-test-integration:
          name: Integration tests
          context:
            - cicd-orchestrator
          requires:
            - Build backend
      - job-test-plugin:
          name: Test plugins
          context:
            - cicd-orchestrator
          requires:
            - Build backend
      - job-sonarcloud-analysis:
          name: Sonar - gravitee-apim-plugin
          context:
            - cicd-orchestrator
          requires:
            - Test plugins
          working_directory: gravitee-apim-plugin
          cache_type: backend
      - job-test-repository:
          name: Test repository
          context:
            - cicd-orchestrator
          requires:
            - Build backend
      - job-sonarcloud-analysis:
          name: Sonar - gravitee-apim-repository
          context:
            - cicd-orchestrator
          requires:
            - Test repository
          working_directory: gravitee-apim-repository
          cache_type: backend
      - job-webui-lint-test:
          name: Lint & test APIM Console
          context:
            - cicd-orchestrator
          apim-ui-project: gravitee-apim-console-webui
          resource_class: xlarge
      - job-webui-build:
          name: Build APIM Console and publish image
          context:
            - cicd-orchestrator
          apim-ui-project: gravitee-apim-console-webui
          docker-image-name: apim-management-ui
      - job-console-webui-build-storybook:
          name: Build Console Storybook
          context:
            - cicd-orchestrator
          node_version: "20.11"
      - job-console-webui-chromatic-deployment:
          name: Deploy console in chromatic
          context:
            - cicd-orchestrator
          requires:
            - Build Console Storybook
          node_version: "20.11"
      - job-sonarcloud-analysis:
          name: Sonar - gravitee-apim-console-webui
          context:
            - cicd-orchestrator
          requires:
            - Lint & test APIM Console
          working_directory: gravitee-apim-console-webui
          cache_type: frontend
      - job-webui-lint-test:
          name: Lint & test APIM Portal
          context:
            - cicd-orchestrator
          apim-ui-project: gravitee-apim-portal-webui
          resource_class: large
          node_version: "20.9"
      - job-webui-build:
          name: Build APIM Portal and publish image
          context:
            - cicd-orchestrator
          apim-ui-project: gravitee-apim-portal-webui
          docker-image-name: apim-portal-ui
          node_version: "20.9"
      - job-sonarcloud-analysis:
          name: Sonar - gravitee-apim-portal-webui
          context:
            - cicd-orchestrator
          requires:
            - Lint & test APIM Portal
          working_directory: gravitee-apim-portal-webui
          cache_type: frontend
      - job-build-images:
          name: Build and push rest api and gateway images
          context:
            - cicd-orchestrator
          requires:
            - Build backend
      - job-e2e-generate-sdk:
          context:
            - cicd-orchestrator
          name: Generate e2e tests SDK
          requires:
            - Build backend
      - job-e2e-lint-build:
          context:
            - cicd-orchestrator
          name: Lint & Build APIM e2e
          requires:
            - Generate e2e tests SDK
      - job-perf-lint-build:
          context:
            - cicd-orchestrator
          name: Lint & Build APIM perf
          requires:
            - Generate e2e tests SDK
      - job-e2e-test:
          context:
            - cicd-orchestrator
          name: E2E - << matrix.execution_mode >> - << matrix.database >>
          requires:
            - Lint & Build APIM e2e
            - Build and push rest api and gateway images
          matrix:
            parameters:
              execution_mode:
                - v3
                - v4-emulation-engine
              database:
                - mongo
                - jdbc
                - bridge
      - job-e2e-cypress:
          context:
            - cicd-orchestrator
          name: Run Cypress UI tests
          requires:
            - Lint & Build APIM e2e
            - Build and push rest api and gateway images
            - Build APIM Console and publish image
            - Build APIM Portal and publish image
      - job-community-build:
          name: Check build as Community user
          context:
            - cicd-orchestrator
      - job-snyk-apim-charts:
          name: Scan snyk Helm chart
          context:
            - cicd-orchestrator
          requires:
            - Setup
      - job-release-helm:
          name: Publish Helm chart (internal repo)
          context:
            - cicd-orchestrator
          requires:
            - Setup
      - job-publish-on-artifactory:
          name: Publish on artifactory
          context:
            - cicd-orchestrator
          requires:
            - Test definition
            - Test gateway
            - Test plugins
            - Test repository
            - Test rest-api
      - job-publish-on-nexus:
          name: Publish on nexus
          context:
            - cicd-orchestrator
          requires:
            - Test definition
            - Test gateway
            - Test plugins
            - Test repository
            - Test rest-api
      - job-deploy-on-azure-cluster:
          name: Deploy on Azure cluster
          context:
            - cicd-orchestrator
          requires:
            - Test definition
            - Test gateway
            - Test plugins
            - Test repository
            - Test rest-api
            - Build and push rest api and gateway images
            - Build APIM Console and publish image
            - Build APIM Portal and publish image
orbs:
  helm: circleci/helm@3.0.0
  keeper: gravitee-io/keeper@0.6.3
  slack: circleci/slack@4.12.5
  gh: circleci/github-cli@1.0.5
  snyk: snyk/snyk@1.7.0
