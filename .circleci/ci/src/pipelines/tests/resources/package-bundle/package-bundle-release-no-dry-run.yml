# This configuration has been automatically generated by the CircleCI Config SDK.
# For more information, see https://github.com/CircleCI-Public/circleci-config-sdk-ts
# SDK Version: 0.0.0-development

version: 2.1
setup: false
parameters:
  gio_action:
    type: string
    default: pull_requests
    description: ""
  dry_run:
    type: boolean
    default: true
    description: Run in dry run mode?
  docker_tag_as_latest:
    type: boolean
    default: false
    description: Is this version the latest version available?
  graviteeio_version:
    type: string
    default: ""
    description: Version of APIM to be used in docker images
  apim_version_path:
    type: string
    default: /home/circleci/project/pom.xml
    description: Path to pom.xml with APIM version
commands:
  cmd-sync-folder-to-s3:
    parameters:
      folder-to-sync:
        type: string
        default: ""
        description: the path of the folder to sync to S3
    steps:
      - keeper/env-export:
          secret-url: keeper://Mqmplmfu17bDR5XRLmO1mQ/field/password
          var-name: AWS_ACCESS_KEY_ID
      - keeper/env-export:
          secret-url: keeper://3-pU56sIqcyWWw7HxhxjaQ/field/password
          var-name: AWS_SECRET_ACCESS_KEY
      - aws-cli/setup:
          region: cloudfront
          version: 2.22.35
      - aws-s3/sync:
          arguments: --endpoint-url https://cellar-c2.services.clever-cloud.com --acl public-read
          from: << parameters.folder-to-sync>>
          to: s3://gravitee-releases-downloads
    description: Sync folder content to Gravitee download website
jobs:
  job-setup:
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - checkout
      - keeper/env-export:
          secret-url: keeper://7CgijuGiFDSLynRJt1Dm9w/custom_field/xml
          var-name: MAVEN_SETTINGS
      - run:
          command: "echo $MAVEN_SETTINGS > .gravitee.settings.xml "
      - persist_to_workspace:
          root: .
          paths:
            - .gravitee.settings.xml
  job-package-bundle:
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Building full-distribution bundle
          command: |
            mkdir -p ./folder_to_sync/graviteeio-apim/distributions/graviteeio-full-4.1.0
            # Console
            cp -r gravitee-apim-console-webui/dist ./folder_to_sync/graviteeio-apim/distributions/graviteeio-full-4.1.0/graviteeio-apim-console-ui-4.1.0

            # Portal
            cp -r gravitee-apim-portal-webui/dist ./folder_to_sync/graviteeio-apim/distributions/graviteeio-full-4.1.0/graviteeio-apim-portal-ui-4.1.0

            # Rest API
            cp -r gravitee-apim-rest-api/gravitee-apim-rest-api-standalone/gravitee-apim-rest-api-standalone-distribution/target/distribution ./folder_to_sync/graviteeio-apim/distributions/graviteeio-full-4.1.0/graviteeio-apim-rest-api-4.1.0

            # Gateway
            cp -r gravitee-apim-gateway/gravitee-apim-gateway-standalone/gravitee-apim-gateway-standalone-distribution/target/distribution ./folder_to_sync/graviteeio-apim/distributions/graviteeio-full-4.1.0/graviteeio-apim-gateway-4.1.0

            cd ./folder_to_sync/graviteeio-apim/distributions
            zip -q -r graviteeio-full-4.1.0.zip graviteeio-full-4.1.0

            md5sum graviteeio-full-4.1.0.zip > graviteeio-full-4.1.0.zip.md5
            sha512sum graviteeio-full-4.1.0.zip > graviteeio-full-4.1.0.zip.sha512sum
            sha1sum graviteeio-full-4.1.0.zip > graviteeio-full-4.1.0.zip.sha1

            rm -rf graviteeio-full-4.1.0
      - cmd-sync-folder-to-s3:
          folder-to-sync: folder_to_sync
workflows:
  package_bundle:
    jobs:
      - job-setup:
          context:
            - cicd-orchestrator
          name: Setup
      - job-package-bundle:
          context:
            - cicd-orchestrator
          name: Package bundle
          requires:
            - Setup
orbs:
  keeper: gravitee-io/keeper@0.7.0
  aws-cli: circleci/aws-cli@5.1.2
  aws-s3: circleci/aws-s3@4.1.0
