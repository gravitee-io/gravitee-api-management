# This configuration has been automatically generated by the CircleCI Config SDK.
# For more information, see https://github.com/CircleCI-Public/circleci-config-sdk-ts
# SDK Version: 0.0.0-development

version: 2.1
setup: false
parameters:
  gio_action:
    type: string
    default: pull_requests
    description: ""
  dry_run:
    type: boolean
    default: true
    description: Run in dry run mode?
  docker_tag_as_latest:
    type: boolean
    default: false
    description: Is this version the latest version available?
  graviteeio_version:
    type: string
    default: ""
    description: Version of APIM to be used in docker images
  apim_version_path:
    type: string
    default: /home/circleci/project/pom.xml
    description: Path to pom.xml with APIM version
commands:
  cmd-install-yarn:
    steps:
      - run:
          name: Yarn Set Version Stable
          command: yarn set version 4.1.1
jobs:
  job-setup:
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - checkout
      - keeper/env-export:
          secret-url: keeper://7CgijuGiFDSLynRJt1Dm9w/custom_field/xml
          var-name: MAVEN_SETTINGS
      - run:
          command: "echo $MAVEN_SETTINGS > .gravitee.settings.xml "
      - persist_to_workspace:
          root: .
          paths:
            - .gravitee.settings.xml
  job-package-bundle:
    docker:
      - image: cimg/openjdk:17.0.8-node
    resource_class: medium
    steps:
      - keeper/env-export:
          secret-url: keeper://R7NuqoW0KD-8l-kjx0-PgQ/field/login
          var-name: ARTIFACTORY_USERNAME
      - keeper/env-export:
          secret-url: keeper://R7NuqoW0KD-8l-kjx0-PgQ/field/password
          var-name: ARTIFACTORY_PASSWORD
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Checkout tag 4.1.0-alpha.1
          command: git checkout 4.1.0-alpha.1
      - cmd-install-yarn
      - run:
          name: Install dependencies
          command: yarn
          working_directory: ./release
      - run:
          name: Building package bundle
          command: yarn zx --quiet --experimental ci-steps/package-bundles.mjs --version=4.1.0-alpha.1
          working_directory: ./release
          environment:
            ARTIFACTORY_REPO_URL: https://odbxikk7vo-artifactory.services.clever-cloud.com/external-dependencies-n-gravitee-all
      - keeper/env-export:
          secret-url: keeper://Mqmplmfu17bDR5XRLmO1mQ/field/password
          var-name: AWS_ACCESS_KEY_ID
      - keeper/env-export:
          secret-url: keeper://3-pU56sIqcyWWw7HxhxjaQ/field/password
          var-name: AWS_SECRET_ACCESS_KEY
      - aws-s3/sync:
          arguments: --endpoint-url https://cellar-c2.services.clever-cloud.com --acl public-read
          from: ./release/.tmp/4.1.0-alpha.1/dist
          to: s3://gravitee-releases-downloads/pre-releases/graviteeio-apim
workflows:
  package_bundle:
    jobs:
      - job-setup:
          context:
            - cicd-orchestrator
          name: Setup
      - job-package-bundle:
          context:
            - cicd-orchestrator
          name: Package bundle
          requires:
            - Setup
orbs:
  keeper: gravitee-io/keeper@0.6.3
  aws-s3: circleci/aws-s3@3.0.0
