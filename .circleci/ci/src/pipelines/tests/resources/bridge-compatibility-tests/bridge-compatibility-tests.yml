# This configuration has been automatically generated by the CircleCI Config SDK.
# For more information, see https://github.com/CircleCI-Public/circleci-config-sdk-ts
# SDK Version: 0.0.0-development

version: 2.1
setup: false
parameters:
  gio_action:
    type: string
    default: pull_requests
    description: ""
  dry_run:
    type: boolean
    default: true
    description: Run in dry run mode?
  docker_tag_as_latest:
    type: boolean
    default: false
    description: Is this version the latest version available?
  graviteeio_version:
    type: string
    default: ""
    description: Version of APIM to be used in docker images
  apim_version_path:
    type: string
    default: /home/circleci/project/pom.xml
    description: Path to pom.xml with APIM version
commands:
  cmd-restore-maven-job-cache:
    parameters:
      jobName:
        type: string
        default: ""
        description: The job name
    steps:
      - restore_cache:
          keys:
            - gravitee-api-management-v9-<< parameters.jobName >>-{{ .Branch }}-{{ checksum "pom.xml" }}
            - gravitee-api-management-v9-<< parameters.jobName >>-{{ .Branch }}
    description: Restore Maven cache for a dedicated job
  cmd-save-maven-job-cache:
    parameters:
      jobName:
        type: string
        default: ""
        description: The job name
    steps:
      - run:
          name: Exclude all APIM artefacts from cache.
          command: rm -rf ~/.m2/repository/io/gravitee/apim
      - save_cache:
          key: gravitee-api-management-v9-<< parameters.jobName >>-{{ .Branch }}-{{ checksum "pom.xml" }}
          paths:
            - ~/.m2
          when: always
    description: Save Maven cache for a dedicated job
  cmd-notify-on-failure:
    steps:
      - keeper/env-export:
          secret-url: keeper://ZOz4db245GNaETVwmPBk8w/field/password
          var-name: SLACK_ACCESS_TOKEN
      - slack/notify:
          channel: C02JENTV2AX
          branch_pattern: master,[0-9]+\.[0-9]+\.x
          event: fail
          template: basic_fail_1
  cmd-webui-install:
    parameters:
      apim-ui-project:
        type: string
        default: ""
        description: the name of the UI project to build
    steps:
      - restore_cache:
          name: Restore NPM cache
          keys:
            - << parameters.apim-ui-project >>-cache-v1-{{ .Branch }}-{{ checksum "<< parameters.apim-ui-project >>/package-lock.json" }}
            - << parameters.apim-ui-project >>-cache-v1-{{ .Branch }}
      - run:
          name: Install dependencies
          command: npm install
          working_directory: << parameters.apim-ui-project >>
      - save_cache:
          name: Save NPM cache
          key: << parameters.apim-ui-project >>-cache-v1-{{ .Branch }}-{{ checksum "<< parameters.apim-ui-project >>/package-lock.json" }}
          paths:
            - ./<< parameters.apim-ui-project >>/node_modules
  cmd-docker-azure-login:
    steps:
      - keeper/env-export:
          secret-url: keeper://Q721P2LSOPJ9qiXLuf5AHQ/field/login
          var-name: AZURE_DOCKER_REGISTRY_USERNAME
      - keeper/env-export:
          secret-url: keeper://Q721P2LSOPJ9qiXLuf5AHQ/field/password
          var-name: AZURE_DOCKER_REGISTRY_PASSWORD
      - run:
          name: Login to Azure Container Registry
          command: echo $AZURE_DOCKER_REGISTRY_PASSWORD | docker login --username $AZURE_DOCKER_REGISTRY_USERNAME --password-stdin graviteeio.azurecr.io
    description: Login to Azure Container Registry
  cmd-docker-azure-logout:
    steps:
      - run:
          name: Logout from Azure Container Registry
          command: docker logout graviteeio.azurecr.io
    description: Logout from Azure Container Registry
jobs:
  job-setup:
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - checkout
      - keeper/env-export:
          secret-url: keeper://7CgijuGiFDSLynRJt1Dm9w/custom_field/xml
          var-name: MAVEN_SETTINGS
      - run:
          command: "echo $MAVEN_SETTINGS > .gravitee.settings.xml "
      - persist_to_workspace:
          root: .
          paths:
            - .gravitee.settings.xml
  job-validate:
    docker:
      - image: cimg/openjdk:17.0.8
    resource_class: small
    steps:
      - checkout
      - attach_workspace:
          at: .
      - cmd-restore-maven-job-cache:
          jobName: job-validate
      - run:
          name: Validate project
          command: mvn -s .gravitee.settings.xml validate --no-transfer-progress -Pall-modules,integration-tests-modules -T 2C
      - cmd-notify-on-failure
      - cmd-save-maven-job-cache:
          jobName: job-validate
  job-build:
    docker:
      - image: cimg/openjdk:17.0.8
    resource_class: large
    steps:
      - checkout
      - attach_workspace:
          at: .
      - cmd-restore-maven-job-cache:
          jobName: job-build
      - run:
          name: Build project
          command: |-
            mvn -s .gravitee.settings.xml clean install --no-transfer-progress --update-snapshots -DskipTests -Dskip.validation=true -T 2C -Dbundle=dev
            mkdir -p ./rest-api-docker-context/distribution && cp -r ./gravitee-apim-rest-api/gravitee-apim-rest-api-standalone/gravitee-apim-rest-api-standalone-distribution/target/distribution ./rest-api-docker-context/.
            mkdir -p ./gateway-docker-context/distribution && cp -r ./gravitee-apim-gateway/gravitee-apim-gateway-standalone/gravitee-apim-gateway-standalone-distribution/target/distribution ./gateway-docker-context/.
          environment:
            BUILD_ID: "1234"
            BUILD_NUMBER: "1234"
            GIT_COMMIT: 784ff35ca
      - cmd-notify-on-failure
      - save_cache:
          paths:
            - ~/.m2/repository/io/gravitee/apim
          key: gravitee-api-management-v9-build-apim-{{ .Environment.CIRCLE_WORKFLOW_WORKSPACE_ID }}
          when: on_success
      - cmd-save-maven-job-cache:
          jobName: job-build
      - persist_to_workspace:
          root: ./
          paths:
            - ./gravitee-apim-rest-api/gravitee-apim-rest-api-management/gravitee-apim-rest-api-management-rest/target/classes/console-openapi.*
            - ./rest-api-docker-context
            - ./gateway-docker-context
  job-e2e-generate-sdk:
    docker:
      - image: cimg/openjdk:17.0.8-node
    resource_class: small
    steps:
      - checkout
      - cmd-webui-install:
          apim-ui-project: gravitee-apim-e2e
      - attach_workspace:
          at: .
      - run:
          name: Generate e2e tests SDK
          command: |-
            npm run update:sdk:management
            npm run update:sdk:management:v2
            npm run update:sdk:portal
          working_directory: gravitee-apim-e2e
      - cmd-notify-on-failure
      - persist_to_workspace:
          root: .
          paths:
            - gravitee-apim-e2e/lib/management-webclient-sdk
            - gravitee-apim-e2e/lib/management-v2-webclient-sdk
            - gravitee-apim-e2e/lib/portal-webclient-sdk
  job-e2e-lint-build:
    docker:
      - image: cimg/node:16.10
    resource_class: small
    steps:
      - checkout
      - cmd-webui-install:
          apim-ui-project: gravitee-apim-e2e
      - attach_workspace:
          at: .
      - run:
          name: Check License
          command: npm run lint:license
          working_directory: gravitee-apim-e2e
      - run:
          name: Run Prettier and ESLint
          command: npm run lint
          working_directory: gravitee-apim-e2e
      - run:
          name: Build
          command: npm run build
          working_directory: gravitee-apim-e2e
      - cmd-notify-on-failure
      - persist_to_workspace:
          root: .
          paths:
            - gravitee-apim-e2e/dist
            - gravitee-apim-e2e/node_modules
  job-e2e-test:
    parameters:
      apim_client_tag:
        type: string
        default: ""
      execution_mode:
        type: string
        default: ""
      database:
        type: string
        default: ""
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: false
    resource_class: medium
    steps:
      - checkout
      - attach_workspace:
          at: .
      - cmd-docker-azure-login
      - keeper/env-export:
          secret-url: keeper://w8WBpALVCgYdxtV5pVrQsw/custom_field/base64
          var-name: GRAVITEE_LICENSE
      - run:
          name: Running API & E2E tests in << parameters.execution_mode >> mode with << parameters.database >> database
          command: |-
            cd gravitee-apim-e2e
            if [ "<< parameters.execution_mode >>" = "v3" ]; then
              echo "Disable v4 emulation engine on APIM Gateway and Rest API"
              export V4_EMULATION_ENGINE_DEFAULT=no
            fi
            if [ -z "<< parameters.apim_client_tag >>" ]; then
              APIM_REGISTRY=graviteeio.azurecr.io APIM_TAG=master-latest APIM_CLIENT_REGISTRY=graviteeio.azurecr.io APIM_CLIENT_TAG=master-latest npm run test:api:<< parameters.database >>
            else 
              if [[ "<< parameters.apim_client_tag >>" == *"@"* ]]; then
                echo "Using custom registry for client"
                CLIENT_REGISTRY=$(echo "<< parameters.apim_client_tag >>" | cut -f1 -d@)
                CLIENT_TAG=$(echo "<< parameters.apim_client_tag >>" | cut -f2 -d@)
                APIM_REGISTRY=graviteeio.azurecr.io APIM_TAG=master-latest APIM_CLIENT_REGISTRY=${CLIENT_REGISTRY} APIM_CLIENT_TAG=${CLIENT_TAG} npm run test:api:<< parameters.database >>
              else
                echo "Using ACR registry for client"
                APIM_REGISTRY=graviteeio.azurecr.io APIM_TAG=master-latest APIM_CLIENT_REGISTRY=graviteeio.azurecr.io APIM_CLIENT_TAG=<< parameters.apim_client_tag >> npm run test:api:<< parameters.database >>
              fi
            fi
      - cmd-docker-azure-logout
      - cmd-notify-on-failure
      - store_test_results:
          path: ./gravitee-apim-e2e/.tmp/e2e-test-report.xml
      - store_artifacts:
          path: ./gravitee-apim-e2e/.tmp/e2e-test-report.xml
      - store_artifacts:
          path: ./gravitee-apim-e2e/.logs
workflows:
  bridge_compatibility_tests:
    jobs:
      - job-setup:
          context:
            - cicd-orchestrator
          name: Setup
      - job-validate:
          context:
            - cicd-orchestrator
          name: Validate
          requires:
            - Setup
      - job-build:
          context:
            - cicd-orchestrator
          name: Build backend
          requires:
            - Validate
      - job-e2e-generate-sdk:
          context:
            - cicd-orchestrator
          name: Generate e2e tests SDK
          requires:
            - Build backend
      - job-e2e-lint-build:
          context:
            - cicd-orchestrator
          name: Lint & Build APIM e2e
          requires:
            - Generate e2e tests SDK
      - job-e2e-test:
          context:
            - cicd-orchestrator
          name: E2E - << matrix.execution_mode >> - << matrix.apim_client_tag >>
          requires:
            - Lint & Build APIM e2e
          matrix:
            parameters:
              execution_mode:
                - v3
                - v4-emulation-engine
              database:
                - bridge
              apim_client_tag:
                - 4.1.x-latest
                - 4.0.x-latest
                - graviteeio@3.20
orbs:
  keeper: gravitee-io/keeper@0.6.3
  slack: circleci/slack@4.12.5
