suite: Test ui deployment
templates:
  - "ui/ui-deployment.yaml"
  - "ui/ui-configmap.yaml"
tests:
  - it: Should generate a CONSOLE_BASE_HREF environment variable
    template: ui/ui-deployment.yaml
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.template.spec.containers[0].env[1].name
          value: "CONSOLE_BASE_HREF"
      - equal:
          path: spec.template.spec.containers[0].env[1].value
          value: "/console/"

  - it: Should generate a CONSOLE_BASE_HREF environment variable when modifying ingress path
    template: ui/ui-deployment.yaml
    set:
      ui:
        ingress:
          path: /
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.template.spec.containers[0].env[1].name
          value: "CONSOLE_BASE_HREF"
      - equal:
          path: spec.template.spec.containers[0].env[1].value
          value: "/"

  - it: Should generate a CONSOLE_BASE_HREF environment variable when modifying ingress path with subpath
    template: ui/ui-deployment.yaml
    set:
      ui:
        ingress:
          path: /4pi-test/console(/.*)?
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.template.spec.containers[0].env[1].name
          value: "CONSOLE_BASE_HREF"
      - equal:
          path: spec.template.spec.containers[0].env[1].value
          value: "/4pi-test/console/"

  - it: Should generate a CONSOLE_BASE_HREF environment variable and add "/" when modifying ingress path
    template: ui/ui-deployment.yaml
    set:
      ui:
        ingress:
          path: /test
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.template.spec.containers[0].env[1].name
          value: "CONSOLE_BASE_HREF"
      - equal:
          path: spec.template.spec.containers[0].env[1].value
          value: "/test/"

  - it: Should override generated CONSOLE_BASE_HREF environment variable
    template: ui/ui-deployment.yaml
    set:
      ui:
        env:
        - name: CONSOLE_BASE_HREF
          value: /test/
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.template.spec.containers[0].env[1].name
          value: "CONSOLE_BASE_HREF"
      - equal:
          path: spec.template.spec.containers[0].env[1].value
          value: "/test/"

  - it: Should have default resources
    template: ui/ui-deployment.yaml
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: "100m"

  - it: Check DB Less mode
    set:
      global:
        kubeVersion: 1.23.0
      apim:
        dbLess: true
    asserts:
      - hasDocuments:
          count: 0

  - it: Deploy with podSecurityContext
    template: ui/ui-deployment.yaml
    set:
      ui:
        deployment:
          podSecurityContext:
            fsGroup: 1001
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Deployment
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 1001