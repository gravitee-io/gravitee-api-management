suite: Test Management API default configmap
templates:
  - "api/api-configmap.yaml"
tests:
  - it: Backward compatible - gravitee.yml is compute from helm values
    set:
      installation:
        api:
          url: https://from.helm.values.apim.example.com
    asserts:
      - matchRegex:
          path: data["gravitee.yml"]
          pattern: |
            installation:
              type: standalone
              api:
                url: https://from.helm.values.apim.example.com

  - it: Raw copy gravitee.yml from helm values
    set:
      api:
        configuration:
          files:
            gravitee_yml:
              installation:
                type: standalone
                api:
                  url: https://overwrite.apim.example.com
                  proxyPath:
                    management: /management
                    portal: /portal
                standalone:
                  console:
                    url: https://apim.example.com/console
                  portal:
                    url: https://apim.example.com
    asserts:
      - equal:
          path: data["gravitee.yml"]
          value: |-
            installation:
              api:
                proxyPath:
                  management: /management
                  portal: /portal
                url: https://overwrite.apim.example.com
              standalone:
                console:
                  url: https://apim.example.com/console
                portal:
                  url: https://apim.example.com
              type: standalone

  - it: Backward compatible - logback.xml is compute from helm values
    set:
      api:
        logging:
          debug: true
          file:
            enabled: true
    asserts:
      - matchRegex:
          path: data["logback.xml"]
          pattern: |
            <appender-ref ref="FILE" />

  - it: Raw copy logback.xml from helm values at api level
    set:
      api:
        logging:
          debug: true
        configuration:
          files:
            logback_xml: |-
              <?xml version="1.0" encoding="UTF-8"?>
              <configuration>
                <root level="WARN">
                  <appender-ref ref="STDOUT" />
                </root>
              </configuration>
    asserts:
      - equal:
          path: data["logback.xml"]
          value: |-
            <?xml version="1.0" encoding="UTF-8"?>
            <configuration>
              <root level="WARN">
                <appender-ref ref="STDOUT" />
              </root>
            </configuration>

  - it: Raw copy logback.xml from helm values at api level also if logging.debug is false
    set:
      api:
        configuration:
          files:
            logback_xml: |-
              <?xml version="1.0" encoding="UTF-8"?>
              <configuration>
                <root level="WARN">
                  <appender-ref ref="STDOUT" />
                </root>
              </configuration>
    asserts:
      - equal:
          path: data["logback.xml"]
          value: |-
            <?xml version="1.0" encoding="UTF-8"?>
            <configuration>
              <root level="WARN">
                <appender-ref ref="STDOUT" />
              </root>
            </configuration>

  - it: Backward compatible - hazelcast-cluster.xml is compute from helm values
    set:
      api:
        federation:
          enabled: true
    asserts:
      - matchRegex:
          path: data["hazelcast-cluster.xml"]
          pattern: |
            <cluster-name>graviteeio-apim-cluster</cluster-name>

  - it: Raw copy hazelcast-cluster.xml from helm values at api level
    set:
      api:
        federation:
          enabled: true
        configuration:
          files:
            hazelcast_cluster_xml: |-
              <?xml version="1.0" encoding="UTF-8"?>
              <hazelcast xmlns="http://www.hazelcast.com/schema/config"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://www.hazelcast.com/schema/config
                  http://www.hazelcast.com/schema/config/hazelcast-config-5.3.xsd">
                <cluster-name>overwrite-graviteeio-apim-cluster</cluster-name>
              </hazelcast>
    asserts:
      - equal:
          path: data["hazelcast-cluster.xml"]
          value: |-
            <?xml version="1.0" encoding="UTF-8"?>
            <hazelcast xmlns="http://www.hazelcast.com/schema/config"
                xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                xsi:schemaLocation="http://www.hazelcast.com/schema/config
                http://www.hazelcast.com/schema/config/hazelcast-config-5.3.xsd">
              <cluster-name>overwrite-graviteeio-apim-cluster</cluster-name>
            </hazelcast>

  - it: Backward compatible - hazelcast-cache.xml is compute from helm values
    set:
      api:
        federation:
          enabled: true
    asserts:
      - matchRegex:
          path: data["hazelcast-cache.xml"]
          pattern: |
            <cluster-name>graviteeio-apim-cache</cluster-name>

  - it: Raw copy hazelcast-cache.xml from helm values at api level
    set:
      api:
        federation:
          enabled: true
        configuration:
          files:
            hazelcast_cache_xml: |-
              <?xml version="1.0" encoding="UTF-8"?>
              <hazelcast xmlns="http://www.hazelcast.com/schema/config"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://www.hazelcast.com/schema/config
                  http://www.hazelcast.com/schema/config/hazelcast-config-5.3.xsd">
                <cluster-name>overwrite-graviteeio-apim-cache</cluster-name>
              </hazelcast>
    asserts:
      - equal:
          path: data["hazelcast-cache.xml"]
          value: |-
            <?xml version="1.0" encoding="UTF-8"?>
            <hazelcast xmlns="http://www.hazelcast.com/schema/config"
                xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                xsi:schemaLocation="http://www.hazelcast.com/schema/config
                http://www.hazelcast.com/schema/config/hazelcast-config-5.3.xsd">
              <cluster-name>overwrite-graviteeio-apim-cache</cluster-name>
            </hazelcast>
