suite: Test Management API - Federation Controller Ingress
templates:
  - "api/api-ingress-federation-controller.yaml"
tests:
  - it: Check federation ingress disabled by default
    asserts:
      - hasDocuments:
          count: 0

  - it: Check federation disabled
    set:
      api:
        federation:
          enabled: false
          ingress:
            enabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: Check federation ingress disabled
    set:
      api:
        federation:
          enabled: true
          ingress:
            enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: Check default federation ingress
    set:
      api:
        federation:
          enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Ingress
      - isAPIVersion:
          of: networking.k8s.io/v1
      - equal:
          path: spec.rules[0].host
          value: apim.example.com
      - equal:
          path: spec.rules[0].http.paths[0].path
          value: /integration-controller(/.*)?
      - equal:
          path: metadata.annotations
          value:
            kubernetes.io/ingress.class: nginx
            nginx.ingress.kubernetes.io/proxy-read-timeout: 3600                                                                                                                                              â”‚
            nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
            nginx.ingress.kubernetes.io/rewrite-target: /$1

  - it: Check federation controller ingress with ingressClassName and kube < 1.18-0
    set:
      global:
        kubeVersion: 1.15.0
      api:
        federation:
          enabled: true
          ingress:
            enabled: true
            ingressClassName: "nginx"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Ingress
      - isAPIVersion:
          of: networking.k8s.io/v1beta1
      - notExists:
          path: spec.ingressClassName

  - it: Check federation controller ingress with ingressClassName and kube >= 1.18-0
    set:
      global:
        kubeVersion: 1.18.0
      api:
        federation:
          enabled: true
          ingress:
            enabled: true
            ingressClassName: "ingress"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Ingress
      - isAPIVersion:
          of: networking.k8s.io/v1beta1
      - equal:
          path: spec.ingressClassName
          value: ingress

  - it: Check federation controller ingress with ingressClassName "none" and kube >= 1.18-0
    set:
      global:
        kubeVersion: 1.18.0
      api:
          federation:
            enabled: true
            ingress:
              enabled: true
              ingressClassName: "none"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Ingress
      - isAPIVersion:
          of: networking.k8s.io/v1beta1
      - notExists:
          path: spec.ingressClassName

  - it: Check Ingress pathType and path
    set:
      global:
        kubeVersion: 1.18.0
      api:
          federation:
            enabled: true
            ingress:
              enabled: true
              pathType: Exact
              path: /test-federation-controller
    asserts:
      - equal:
          path: spec.rules[0].http.paths[0].pathType
          value: Exact
      - equal:
          path: spec.rules[0].http.paths[0].path
          value: /test-federation-controller

  - it: Check overridden hosts federation ingress
    set:
      api:
        federation:
          enabled: true
          ingress:
            hosts:
              - host1.example.com
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Ingress
      - isAPIVersion:
          of: networking.k8s.io/v1
      - equal:
          path: spec.rules[0].host
          value: host1.example.com
      - equal:
          path: spec.rules[0].http.paths[0].path
          value: /integration-controller(/.*)?

  - it: Check management tls configuration by default
    set:
      api:
        federation:
          enabled: true
        ingress:
          management:
            tls:
              - hosts:
                  - tls.example.com
                secretName: api-custom-cert
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Ingress
      - isAPIVersion:
          of: networking.k8s.io/v1
      - equal:
          path: spec.tls[0].hosts[0]
          value: tls.example.com
      - equal:
          path: spec.tls[0].secretName
          value: api-custom-cert

  - it: Check overridden tls configuration
    set:
      api:
        ingress:
          management:
            tls:
              - hosts:
                  - tls.example.com
                secretName: api-custom-cert
        federation:
          enabled: true
          ingress:
            tls:
              - hosts:
                  - federation.example.com
                secretName: federation-custom-cert
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Ingress
      - isAPIVersion:
          of: networking.k8s.io/v1
      - equal:
          path: spec.tls[0].hosts[0]
          value: federation.example.com
      - equal:
          path: spec.tls[0].secretName
          value: federation-custom-cert

  - it: Check customIngress overridden default ingress
    set:
      api:
        enabled: true
        federation:
          enabled: true
          customFederationIngress:
            metadata:
              name: dev-apim-cp-c96320-api-bridge
              labels:
                app.kubernetes.io/component: api
                app.kubernetes.io/instance: dev-apim-cp-c96320
              annotations:
                kubernetes.io/ingress.class: nginx
                nginx.ingress.kubernetes.io/rewrite-target: /$1
            spec:
              ingressClassName: nginx-internal
              rules:
                - host: dev.eu.c96320.federation.gravitee.dev.internal
                  http:
                    paths:
                      - backend:
                          service:
                            name: dev-apim-cp-c96320-api
                            port:
                              number: 72
                        path: "/integration-controller(/.*)?"
                        pathType: Prefix
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Ingress
      - isAPIVersion:
          of: networking.k8s.io/v1
      - equal:
          path: metadata.name
          value: dev-apim-cp-c96320-api-bridge
      - equal:
          path: spec.ingressClassName
          value: nginx-internal
      - equal:
          path: spec.rules[0].host
          value: dev.eu.c96320.federation.gravitee.dev.internal
