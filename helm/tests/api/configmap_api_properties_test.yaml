suite: Test Management API default configmap - API properties
templates:
  - "api/api-configmap.yaml"
tests:
  - it: Doesn't set API properties by default
    template: api/api-configmap.yaml
    asserts:
      - notMatchRegex:
          path: data["gravitee.yml"]
          pattern: "api:\n\\s+properties:"

  - it: Set the API properties
    template: api/api-configmap.yaml
    set:
      api:
        enabled: true
        api:
          properties:
            encryption:
              secret: aSecret
    asserts:
      - matchRegex:
          path: data["gravitee.yml"]
          pattern: "(?s)api:.*?properties:.*?encryption:.*?secret: aSecret"

  - it: should prioritize new repositories hierarchy over legacy management
    template: api/api-configmap.yaml
    set:
      api:
        enabled: true
      repositories:
        management:
          type: mongodb
          mongodb:
            uri: mongodb://new-path:27017/db
    asserts:
      - matchRegex:
          path: data["gravitee.yml"]
          pattern: "(?s)repositories:.*?management:.*?uri: mongodb://new-path:27017/db"
      - notMatchRegex:
          path: data["gravitee.yml"]
          pattern: "(?m)^management:"