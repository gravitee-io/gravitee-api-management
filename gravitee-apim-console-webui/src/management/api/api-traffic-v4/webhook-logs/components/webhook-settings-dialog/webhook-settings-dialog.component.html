<!--
  Copyright (C) 2015 The Gravitee team (http://gravitee.io)

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<span mat-dialog-title>Webhook Logs Settings</span>

@if (isLoading) {
  <mat-dialog-content>
    <p>Loading settings...</p>
  </mat-dialog-content>
} @else {
  <form [formGroup]="form" (ngSubmit)="save()">
    <mat-dialog-content>
      <div class="settings-content__header">
        <p class="settings-content__description">
          This enables reporting of your data inside your analytics databases i.e. ElasticSearch or OpenSearch.
        </p>
        <mat-slide-toggle formControlName="enabled" color="primary" class="settings-content__toggle">
          {{ form.value.enabled ? 'Enabled' : 'Disabled' }}
        </mat-slide-toggle>
      </div>

      <gio-banner-info class="logging-banner">
        <span> Opt for logging checkboxes carefully, this requires extra storage and may affect API performance. </span>
      </gio-banner-info>

      <div class="settings__form-control">
        <div class="settings__form-control__title">Content data</div>
        <div class="settings__form-control__toggles">
          <mat-slide-toggle formControlName="requestBody">Request body</mat-slide-toggle>
          <mat-slide-toggle formControlName="requestHeaders">Request headers</mat-slide-toggle>
          <mat-slide-toggle formControlName="responseBody">Response body</mat-slide-toggle>
          <mat-slide-toggle formControlName="responseHeaders">Response headers</mat-slide-toggle>
        </div>
      </div>

      <div class="settings__form-control">
        <div class="settings__form-control__title">Message sampling</div>
        <div class="settings__form-control__subtitle">Set a personalized sampling configuration.</div>
        <mat-button-toggle-group formControlName="samplingType" class="sampling-type" aria-label="Sampling type">
          <mat-button-toggle class="sampling-type__toggle" value="PROBABILITY">Probabilistic</mat-button-toggle>
          <mat-button-toggle class="sampling-type__toggle" value="COUNT">Count</mat-button-toggle>
          <!-- TODO: Backend support pending - will error on save until implemented -->
          <mat-button-toggle class="sampling-type__toggle" value="COUNT_PER_TIME_WINDOW">Count per time window</mat-button-toggle>
          <mat-button-toggle class="sampling-type__toggle" value="TEMPORAL">Temporal</mat-button-toggle>
        </mat-button-toggle-group>

        <ng-container *ngIf="form.get('samplingType').value === 'PROBABILITY'">
          <p>Samples messages based on a specified probability.</p>
          <p>The value should be between 0.01 and 0.5.</p>
          <mat-form-field>
            <mat-label>Message sampling</mat-label>
            <input matInput type="number" formControlName="samplingValue" />
            <mat-error *ngIf="form.get('samplingValue').hasError('required')">The sampling value is required.</mat-error>
            <mat-error *ngIf="form.get('samplingValue').hasError('min')">The sampling value should be greater than 0.01.</mat-error>
            <mat-error *ngIf="form.get('samplingValue').hasError('max')">The sampling value should be lower than 0.5.</mat-error>
          </mat-form-field>
        </ng-container>

        <ng-container *ngIf="form.get('samplingType').value === 'COUNT'">
          <p>Samples one message for every number of specified messages.</p>
          <p>The value should be greater than 10.</p>
          <mat-form-field>
            <mat-label>Message sampling</mat-label>
            <input matInput type="number" formControlName="samplingValue" />
            <mat-error *ngIf="form.get('samplingValue').hasError('required')">The sampling value is required.</mat-error>
            <mat-error *ngIf="form.get('samplingValue').hasError('min')">The sampling value should be greater than 10.</mat-error>
          </mat-form-field>
        </ng-container>

        <ng-container *ngIf="form.get('samplingType').value === 'COUNT_PER_TIME_WINDOW'">
          <p>How many messages to log per time window</p>
          <p>The value should be greater than 1.</p>
          <div class="settings__form-control__sampling-fields">
            <mat-form-field appearance="outline">
              <mat-label>Message count *</mat-label>
              <input matInput type="number" formControlName="messageCount" min="1" />
              <mat-error *ngIf="form.get('messageCount').hasError('required')">Message count is required.</mat-error>
              <mat-error *ngIf="form.get('messageCount').hasError('min')">The value should be greater than 1.</mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Time window (seconds)</mat-label>
              <input matInput type="number" formControlName="timeWindow" min="1" />
              <mat-error *ngIf="form.get('timeWindow').hasError('required')">Time window is required.</mat-error>
              <mat-error *ngIf="form.get('timeWindow').hasError('min')">The value should be greater than 1.</mat-error>
            </mat-form-field>
          </div>
        </ng-container>

        <ng-container *ngIf="form.get('samplingType').value === 'TEMPORAL'">
          <p>Samples messages based on time duration.</p>
          <p>The value should conform to ISO-8601 duration format, e.g. PT1S for a duration of 1 second and be greater than PT1S.</p>
          <mat-form-field>
            <mat-label>Message sampling</mat-label>
            <input matInput formControlName="samplingValue" />
            <mat-error *ngIf="form.get('samplingValue').hasError('required')">The sampling value is required.</mat-error>
          </mat-form-field>
        </ng-container>
      </div>
    </mat-dialog-content>

    <mat-dialog-actions class="actions">
      <button mat-stroked-button type="button" (click)="cancel()">Cancel</button>
      <button mat-flat-button color="primary" type="submit" [disabled]="form.invalid">Save</button>
    </mat-dialog-actions>
  </form>
}
