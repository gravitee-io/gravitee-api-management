<!--
 *
 *    Copyright (C) 2026 The Gravitee team (http://gravitee.io)
 *
 *    Licensed under the Apache License, Version 2.0 (the "License");
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *            http://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an "AS IS" BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 *
-->

<h2 mat-dialog-title>Add API</h2>

<form autocomplete="off" (ngSubmit)="submit()">
  <mat-dialog-content class="dialog-content">
    <!-- Information Box -->
    <gio-banner-info>
      Can't see all your APIs? APIs must have API products enabled before they appear in the list.
    </gio-banner-info>

    <!-- Selected APIs as Chips -->
    @if (selectedApis.length > 0) {
      <div class="selected-apis-section">
        <h3 class="selected-apis-section__header">APIs added to this product</h3>
        <mat-chip-set class="selected-apis-section__chips">
          @for (api of selectedApis; track api.id) {
            <mat-chip
              class="selected-apis-section__chip"
              [removable]="true"
              (removed)="removeApi(api)"
              [attr.aria-label]="'Remove ' + api.name"
              data-testid="selected-api-chip"
            >
              <gio-avatar
                class="selected-apis-section__chip-avatar"
                [src]="api._links?.pictureUrl"
                [name]="api.name + ' ' + api.apiVersion"
                [size]="24"
                [roundedBorder]="true"
              ></gio-avatar>
              <span class="selected-apis-section__chip-name">{{ api.name }}</span>
              @if (api | apiContextPath; as contextPath) {
                <span class="selected-apis-section__chip-path">{{ contextPath }}</span>
              }
              @if (api.lifecycleState === 'DEPRECATED') {
                <span class="selected-apis-section__chip-badge deprecated-badge">Deprecated</span>
              }
              <mat-icon matChipRemove>cancel</mat-icon>
            </mat-chip>
          }
        </mat-chip-set>
      </div>
    }

    <!-- API Selection Field -->
    <mat-form-field appearance="outline" class="form-field">
      <mat-label>Add APIs</mat-label>
      <input matInput type="search" [matAutocomplete]="auto" [formControl]="searchApiControl" data-testid="api-select-input" />
      @if (searchApiControl.value) {
        <button matSuffix mat-icon-button aria-label="Clear input" (click)="resetSearchTerm()">
          <mat-icon>close</mat-icon>
        </button>
      }
      <mat-autocomplete
        #auto="matAutocomplete"
        (optionSelected)="selectAPI()"
        [displayWith]="displayFn"
        [disableRipple]="false"
      >
        @if (filteredOptions$ | async; as filteredOptions) {
          @if (filteredOptions.length > 0) {
            @for (option of filteredOptions; track option.id) {
              <mat-option [value]="option" data-testid="api-select-option">
                <span class="autocompleteRow">
                  <gio-avatar
                    class="autocompleteRow__avatar"
                    [src]="option._links?.pictureUrl"
                    [name]="option.name + ' ' + option.apiVersion"
                    [size]="28"
                    [roundedBorder]="true"
                  ></gio-avatar>
                  <span>{{ option.name }} - {{ option.apiVersion }}</span>
                </span>
              </mat-option>
            }
          } @else {
            @if (searchApiControl.value | isNonEmptyString) {
              <mat-option disabled>No APIs matching search criteria</mat-option>
            }
          }
        }
      </mat-autocomplete>
    </mat-form-field>

  </mat-dialog-content>

  <mat-dialog-actions class="actions">
    <button type="button" mat-button (click)="onCancelClick()" [disabled]="isSubmitting" data-testid="cancel-button">Cancel</button>
    <button type="submit" [disabled]="selectedApis.length === 0 || isSubmitting" mat-raised-button color="primary" data-testid="submit-button">
      @if (isSubmitting) {
        Adding...
      } @else {
        Add API
      }
    </button>
  </mat-dialog-actions>
</form>
